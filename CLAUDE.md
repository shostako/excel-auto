# excel-auto プロジェクト設定

## 必読ファイル（IMPORTANT: 作業開始前に必ず読むこと）

**YOU MUST** 以下のファイルを作業開始時に読み込んでから作業を開始すること：

1. `/home/shostako/ClaudeCode/excel-auto/docs/excel-knowledge/failures/001_activate_vs_screenupdating.md`
   - 画面ちらつき問題の根本原因（Activateメソッド）
   
2. `/home/shostako/ClaudeCode/excel-auto/docs/excel-knowledge/patterns/VBA_OPTIMIZATION_PATTERNS.md`
   - VBA最適化の基本パターン
   
3. `/home/shostako/ClaudeCode/excel-auto/docs/excel-knowledge/techniques/VBA_BASIC_TECHNIQUES.md`
   - 基本テクニック集

これらの内容を踏まえずにコードを書くと、同じ失敗を繰り返すことになる。

## 基本ルール

### 出力形式ルール

#### VBAマクロ生成
- **形式**: 直接ファイル作成（.basファイル）
- **保存先**: `src/`ディレクトリ
- **コメント**: 日本語
- **完了メッセージ**: エラー時以外は表示しない
- **エンコーディング**: UTF-8（変換スクリプトでShift-JIS化）
- **自動変換**: 有効（生成・修正後に自動的にShift-JIS変換を実行）

#### Power Query (M言語) 生成
- **形式**: 直接ファイル作成（.pq または .txt）
- **保存先**: `src/`ディレクトリ
- **コメント**: 日本語

#### 関数・数式生成
- **形式**: 通常メッセージ内に記載
- **説明**: 日本語で使用方法を説明

## コーディング標準

### エラーハンドリング
```vba
Sub 処理名()
    Application.StatusBar = "処理を開始します..."
    
    On Error GoTo ErrorHandler
    
    ' メインの処理
    
    Application.StatusBar = False
    Exit Sub
    
ErrorHandler:
    Application.StatusBar = False
    MsgBox "エラーが発生しました: " & Err.Description & vbCrLf & _
           "エラー番号: " & Err.Number, vbCritical
End Sub
```

### 進捗表示
- **ステータスバー使用**: 必須（長時間処理時）
- **更新頻度**: 100件ごと、または処理段階ごと
- **クリア方法**: `Application.StatusBar = False`
- **注意**: 専用のクリアマクロは作らない

### モジュール命名規則
- **接頭辞**: `m` を付ける（例: `m日別集計_モールFR別`）
- **命名**: 日本語可、アンダースコア区切り

## マクロ開発フロー

1. **要件確認**
   - 入力元（シート名、テーブル名）
   - 出力先（シート名、テーブル名）
   - 処理内容の明確化

2. **コード生成**
   - `src/`ディレクトリに.basファイルとして保存
   - モジュール名を正しく設定
   - **自動変換が実行される**（Shift-JISでWindows側に保存）

3. **手動変換**（必要な場合のみ）
   ```bash
   bas2sjis src/マクロ名.bas
   ```

4. **テスト方法**
   - ExcelのVBEでインポート
   - 実データでテスト実行

## 重要な制約事項

### 参考マクロの読み込み（超重要！）
**必須事項**: 参考マクロフォルダのファイルは**必ず文字コード変換してから読むこと**

```bash
# 読む前に必ず実行
iconv -f SHIFT-JIS -t UTF-8 "参考マクロ/ファイル名.bas" | head -100
```

**理由**: 
- ユーザーがExcelからエクスポートしたファイルは**Shift-JIS**
- そのまま読むと文字化けして**列名を誤認識**する
- 過去の事故例：文字化けした列名で修正→本番で動作しない

**禁止事項**:
- 文字化けしたまま読み進めること
- 文字化けした内容を基に修正すること
- UTF-8版があってもオリジナルの確認を怠ること

### 画面更新の抑制について
- `Application.ScreenUpdating = False` は**積極的に使用する**（高速化の基本）
- CommandButtonから呼び出される場合の注意点：
  - 個別マクロの最後で`True`に戻さない（CommandButtonに任せる）
  - 重複設定は無害なので気にしない
- **絶対に使わない：`Activate`メソッド**
  - これが画面ちらつきの真犯人
  - データ処理にシート切り替えは不要
  - オブジェクト参照で直接操作すること

### メッセージ表示
- **正常終了時**: メッセージボックス表示なし
- **エラー時のみ**: MsgBoxで詳細表示
- **進捗**: ステータスバーのみ使用

### データ処理の最適化
- 配列処理を優先（Range操作の最小化）
- Dictionaryオブジェクトの活用
- 大量データ時は進捗表示必須

## デバッグ支援

### Debug.Print活用
- 日付変換エラーなどの警告出力
- 本番環境でも残しておく（イミディエイトウィンドウ確認用）

### エラー情報の詳細化
- エラー番号とDescription両方を表示
- 可能な限り発生箇所を特定できる情報を含める

## 思考プロセスの活用（Claude標準thinking機能）

### 概要
- Claude標準の内部思考機能を活用
- ユーザーには見えない思考プロセスで問題を整理
- sequential-thinkingツールは使わない（重いため）

### 使用推奨場面
- **複雑なデータ構造設計**: テーブル間の関係性整理
- **アルゴリズム最適化**: 複数の処理方法の比較
- **エラー原因の特定**: 段階的な問題の切り分け
- **曖昧な仕様の明確化**: 要件の整理と確認事項の洗い出し

### 効果的な活用
- グループ化ロジックの設計前
- 日付・時間処理の妥当性検証
- パフォーマンスボトルネックの特定
- エラーハンドリング戦略の決定

## GitHub Action / Claude Code Action 対応ルール

### 基本理解
- **Claude Code Action**: Issue `@claude`コメント → 解説作成 → ブランチ作成まで自動実行
- **PR作成・マージ**: 手動必須（Claudeまたはユーザーが実行）

### ユーザーが状況確認を依頼した場合の自動対応

#### 確認トリガー
ユーザーが以下を言った場合、即座に状況確認と次アクション実行：
- 「確認してくれ」「どうなってる？」「終わったか？」
- 「Issueの対応確認」「Action状況チェック」

#### 自動実行フロー
1. **並行状況確認**（必須）
   - Issue状況確認（コメント数、状態）
   - PR状況確認（最新PR、マージ状況）
   - Claude Actionブランチ確認

2. **状況判定と自動対応**

**パターンA: Claude Action完了済み**
- Issue にClaude完了コメント + PRリンクあり
- **自動対応**: 即座にPR作成実行
- **ユーザー報告**: 「PR #XX作成完了。マージしてくれ」

**パターンB: Claude Action作業中**
- Issue にコメントあり、PRリンクなし
- **自動対応**: 経過報告のみ
- **ユーザー報告**: 「作業中。あと数分待て」

**パターンC: Claude Action未応答**
- Issue にコメント追加なし
- **自動対応**: 待機推奨
- **ユーザー報告**: 「未応答。Issue再投稿するか？」

#### 役割分担の明確化
- **Claude実行**: 状況確認、PR作成、Issue作成
- **ユーザー実行**: PRマージ、リポジトリ設定変更

#### 標準応答例
```
Claude Action完了。PR #XX作成済み。
マージして完了させてくれ。
```

**重要**: この対応は「確認してくれ」発言時に自動実行する。ユーザーからの追加指示は不要。

---

**注意**: 技術的正確性と効率を最優先とする。