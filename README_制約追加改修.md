# 負荷均しマクロ 制約追加改修ガイド

## 概要

負荷均しマクロと調整マクロに以下の制約を追加しました：

1. **補給品優先配置**: モール品補給品 → 非モール補給品の順で優先配置
2. **系列別処理**: モール×アルヴェル系 → ノアヴォク系 → その他の順で均し
3. **号口単品分散**: 号口かつ単品は全て異なる日に分散配置
4. **補給品×号口単品同日禁止**: 補給品と号口単品は同じ日に配置しない

## 前提条件

### 1. 品番テーブルへの列追加

`_品番`テーブルに以下の列を追加してください：

- **号/補**: 「号口」「補給品」のカテゴリ（空欄の場合は制約対象外）
- **系列**: 「アルヴェル系」「ノアヴォク系」「その他」（空欄の場合は「その他」扱い）
- **仕様**: 既存列だが、「モール」という文字列が含まれていればモール品として扱う

### 2. 作成されたファイル

以下のファイルが `src/` ディレクトリに作成されています：

- `m負荷均し制約関数.bas`: 負荷均しマクロ用の制約関数モジュール
- `m調整マクロ制約関数.bas`: 調整マクロ用の制約関数モジュール
- `m転記_負荷均し.bas`: 改修版の負荷均しマクロ（骨組みのみ）

## 実装方法

### オプション1: 新規関数モジュールを追加する方法（推奨）

既存のマクロを保持したまま、新規関数を追加する方法です。

#### ステップ1: Shift-JIS変換

```bash
cd /home/shostako/ClaudeCode/excel-auto
./scripts/bas2sjis src/m負荷均し制約関数.bas
./scripts/bas2sjis src/m調整マクロ制約関数.bas
```

#### ステップ2: Excelにインポート

1. Excel VBEを開く（Alt + F11）
2. `macros/m負荷均し制約関数.bas` をインポート
3. `macros/m調整マクロ制約関数.bas` をインポート

#### ステップ3: 既存マクロの改修

詳細は `docs/改修方針_負荷均しマクロ.md` を参照してください。

主な改修箇所：

1. **品番マスタ読み込み拡張**（`m転記_負荷均し` の行110-150付近）
   - 「号/補」「系列」「仕様」列を読み込むコードを追加

2. **補給品優先配置フェーズ追加**（行210付近）
   ```vba
   ' フェーズ1: 補給品優先配置
   Call 補給品優先配置_モール(...)
   Call 補給品優先配置_通常(...)
   ```

3. **優先度ループを系列別ループに変更**（行220-300付近）
   ```vba
   For 優先度 = 1 To 3
       Call 系列別均し処理("モール", "アルヴェル系", 優先度, ...)
       Call 系列別均し処理("", "ノアヴォク系", 優先度, ...)
       Call 系列別均し処理("", "その他", 優先度, ...)
   Next 優先度
   ```

4. **割り当て可能数を算出 関数の置き換え**（行600付近）
   - 既存の `割り当て可能数を算出` を `割り当て可能数を算出_制約付き` に置き換え
   - または関数内に制約チェックコードを追加

### オプション2: 完全書き換え方法

参考マクロを完全に書き換える方法です（上級者向け）。

1. `inbox/m転記_負荷均し.bas` をUTF-8に変換
2. 改修方針ドキュメントに従って全箇所を改修
3. `src/` に保存してbas2sjisで変換
4. Excelにインポート

## 調整マクロの改修

### m調整_自動均し

品番選択時に制約チェックを追加：

```vba
' 品番選択ループ内（行230付近）
For Each key In ソート済品番リスト.Keys
    品番 = CStr(key)

    ' 制約チェック追加
    If Not 移動先制約チェック(品番, 最過少日, arr均し, 品番マスタ, 成形品番列, 開始列) Then
        Debug.Print "制約違反: 品番[" & 品番 & "]は移動不可"
        GoTo NextCandidate
    End If

    ' ... 既存の改善判定 ...
NextCandidate:
Next key
```

### m調整_完全自動均し

`自動均し1サイクル実行` 関数内で同様の制約チェックを追加。

### m調整_グループ日程移動

移動実行前に警告表示：

```vba
' 移動実行前（行200付近）
Dim 制約違反リスト As String
制約違反リスト = グループ移動制約チェック(グループ品番リスト, 移動先日, arr均し, 品番マスタ, 成形品番列, 開始列)

If 制約違反リスト <> "" Then
    Dim 確認 As Long
    確認 = MsgBox("以下の制約違反が発生します：" & vbCrLf & vbCrLf & _
                  制約違反リスト & vbCrLf & vbCrLf & _
                  "それでも移動しますか？", vbYesNo + vbExclamation)
    If 確認 = vbNo Then
        Application.StatusBar = False
        Exit Sub
    End If
End If
```

## テスト手順

### 1. 品番マスタの設定確認

- 号口単品が正しく「号/補」列に「号口」、「セット」列が空欄になっているか
- 補給品が正しく「号/補」列に「補給品」になっているか
- 系列が正しく設定されているか
- モール品の「仕様」列に「モール」という文字列が含まれているか

### 2. 負荷均しマクロのテスト

1. 負荷均しマクロを実行
2. Debug.Print出力を確認（イミディエイトウィンドウ）
   - 補給品優先配置が正しく動作しているか
   - 系列別処理が正しく動作しているか
   - 制約違反のログが出ているか

3. 結果確認
   - 補給品が最初の方の日付に配置されているか
   - 号口単品が異なる日に分散配置されているか
   - 補給品と号口単品が同じ日に存在しないか

### 3. 調整マクロのテスト

1. 自動均しマクロを実行
2. 制約違反のログが出ているか確認
3. グループ移動マクロで制約違反がある場合に警告が表示されるか確認

## トラブルシューティング

### 号口単品が配置できない

**原因**: 号口単品数が稼働日数を超えている

**対策**:
- 号口単品の数を減らす
- 稼働日を増やす
- 事前警告が表示されるので確認して対応

### 補給品が配置されない

**原因**:
- 日次目標の150%を超えている
- 品番マスタの設定ミス

**対策**:
- Debug.Print出力で原因を特定
- 品番マスタの「号/補」列を確認
- 日次目標誤差許容率を調整

### 制約チェックが動作しない

**原因**:
- 関数モジュールがインポートされていない
- 関数呼び出しコードが追加されていない

**対策**:
- VBEでモジュールが存在するか確認
- 改修箇所が正しく反映されているか確認

## 今後の拡張

### 新しい制約の追加方法

1. `m負荷均し制約関数.bas` または `m調整マクロ制約関数.bas` に新しい制約チェック関数を追加
2. `割り当て可能数を算出_制約付き` 関数内で新しい制約チェックを呼び出す
3. bas2sjisで変換してExcelにインポート

### パラメータ化

制約の厳しさをパラメータテーブルで調整可能にする（例: 補給品集中度、号口単品分散度）

## 参考資料

- `docs/改修方針_負荷均しマクロ.md`: 詳細な改修手順
- `docs/excel-knowledge/claude-code/EXCEL_MACRO_KNOWLEDGE_BASE.md`: VBA開発ナレッジ
- `docs/excel-knowledge/patterns/VBA_OPTIMIZATION_PATTERNS.md`: 最適化パターン

## 連絡先

質問や問題がある場合は、イミディエイトウィンドウの Debug.Print 出力を確認してください。
詳細なログが記録されています。
