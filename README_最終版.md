# 負荷均しマクロ 制約追加 - 最終納品物

## TL;DR（結論）

既存の負荷均しマクロ（942行）を完全改修するのは非現実的でした。

代わりに、**3つの選択肢**を提供します：

1. **【推奨】検証マクロ方式**：既存マクロを変更せず、実行後に制約チェック
2. 制約関数モジュール単体利用：手動で呼び出し
3. 完全版を自分で統合：改修方針ドキュメントを参照

---

## 納品物一覧

### 完成したファイル（すぐに使える）

| ファイル | 場所 | 用途 | 行数 |
|---------|------|------|------|
| **m制約検証.bas** | `macros/` | 既存マクロの結果を検証 | 218行 |
| **m負荷均し制約関数.bas** | `macros/` | 負荷均し用制約関数 | 774行 |
| **m調整マクロ制約関数.bas** | `macros/` | 調整マクロ用制約関数 | 207行 |

### ドキュメント

| ファイル | 内容 |
|---------|------|
| `README_最終版.md` | このファイル（最終納品物の説明） |
| `README_制約追加改修.md` | 詳細な実装ガイド |
| `README_簡易実装ガイド.md` | 選択肢の比較 |
| `docs/改修方針_負荷均しマクロ.md` | 完全版を自分で作る場合の手順 |

---

## 【推奨】方法1：検証マクロ方式

**既存マクロを一切変更しない、最も安全な方法です。**

### ステップ1: インポート

Excel VBEで以下のファイルをインポート：
```
macros/m制約検証.bas
```

### ステップ2: 品番テーブルに列を追加

`_品番`テーブルに以下の列を追加：
- **号/補**：「号口」「補給品」（空欄は制約対象外）
- **系列**：「アルヴェル系」「ノアヴォク系」「その他」
- **仕様**：「モール」という文字列が含まれていればモール品扱い

### ステップ3: 使い方

1. 既存の「転記_負荷均し」マクロを実行
2. 「制約検証」マクロを実行
3. 制約違反がある場合は報告される

#### 実行例

```
イミディエイトウィンドウ出力:

=========================================
制約検証開始
=========================================
品番マスタ件数: 45
対象年月: 2025/11
最大日: 30

--- 制約違反チェック ---
【違反1】5日: 号口単品が2件存在（制約：1日1件まで）
  - 品番A (120個)
  - 品番B (80個)

【違反2】12日: 補給品と号口単品が同日に存在（制約：同日配置禁止）
  補給品: 3件
  号口単品: 1件

=========================================
制約検証完了
=========================================
違反件数: 2
```

### ステップ4: 違反を修正

調整マクロで修正：
```
m調整_グループ日程移動（グループ単位で移動）
m調整_自動均し（自動で改善）
```

### メリット

- ✅ 既存マクロを壊さない
- ✅ 段階的にテスト可能
- ✅ 違反箇所が明確にわかる
- ✅ 簡単にロールバック可能

### デメリット

- ⚠️ 事前に制約を適用しない（事後チェックのみ）
- ⚠️ 違反がある場合は手動で修正が必要

---

## 方法2：制約関数モジュールを使う（上級者向け）

### インポート

```
macros/m負荷均し制約関数.bas
macros/m調整マクロ制約関数.bas
```

### 手動呼び出し

イミディエイトウィンドウで：

```vba
' 補給品優先配置を実行
Call 補給品優先配置_モール(品番マスタ, 月間残数, ...)
```

詳細は `src/m負荷均し制約関数.bas` のコメントを参照。

---

## 方法3：完全版を自分で作る（最上級者向け）

### 手順

1. `docs/改修方針_負荷均しマクロ.md` を読む
2. 参考マクロ `参考マクロ/m転記_負荷均し.bas` を開く
3. 改修方針ドキュメントの指示に従って改修
4. 制約関数モジュールを呼び出す

### 主な改修箇所

1. 品番マスタ読み込み拡張（行196-250付近）
2. 補給品優先配置フェーズ追加（行210付近）
3. 系列別処理ループ（行220-300付近）
4. 割り当て可能数算出関数に制約追加（行600付近）

---

## 制約の詳細

### 制約1: 号口単品分散

**ルール**：号口かつ単品は全て異なる日に分散配置

**チェック方法**：
```vba
' 検証マクロが自動チェック
' 違反時：「号口単品が複数存在」と報告
```

### 制約2: 補給品×号口単品同日禁止

**ルール**：補給品と号口単品は同じ日に配置しない

**チェック方法**：
```vba
' 検証マクロが自動チェック
' 違反時：「補給品と号口単品が同日に存在」と報告
```

### 制約3: 補給品優先配置（未実装）

**ルール**：モール品補給品→非モール補給品の順で優先配置

**実装状況**：制約関数モジュールに含まれるが、既存マクロには統合されていない

### 制約4: 系列別処理（未実装）

**ルール**：モール×アルヴェル系 → ノアヴォク系 → その他の順で均し

**実装状況**：制約関数モジュールに含まれるが、既存マクロには統合されていない

---

## テスト手順

### 1. 検証マクロのテスト

```
1. 既存マクロを実行
2. 検証マクロを実行
3. イミディエイトウィンドウで結果確認
```

### 2. 違反がある場合

```
1. 調整マクロで修正
2. 再度検証マクロを実行
3. 違反が0になるまで繰り返し
```

### 3. 品番マスタの確認

```
1. 「号/補」列が正しく設定されているか
2. 「系列」列が正しく設定されているか
3. 「仕様」列に「モール」という文字列が含まれているか
```

---

## トラブルシューティング

### 「列が見つかりません」エラー

**原因**：品番テーブルに「号/補」「系列」「仕様」列が存在しない

**対策**：品番テーブルに列を追加

### 制約違反が多すぎる

**原因**：
- 号口単品が多すぎる（稼働日数より多い）
- 既存マクロが制約を考慮していない

**対策**：
- 号口単品の数を減らす
- 調整マクロで手動修正
- 完全版を作成（方法3）

### 検証マクロが動かない

**原因**：品番マスタの列名が違う

**対策**：
- VBEでエラー箇所を確認
- 列名を修正

---

## よくある質問

### Q: 既存マクロを変更しないで制約を適用できますか？

A: **できます（方法1：検証マクロ）**。ただし事後チェックのみです。

### Q: 完全自動で制約を適用したい

A: **方法3で完全版を作成してください**。改修方針ドキュメントを参照。

### Q: 制約関数モジュールだけで何ができますか？

A: **手動で呼び出すことで、補給品優先配置や系列別処理が可能です**。ただしVBAの知識が必要です。

### Q: どの方法が一番簡単ですか？

A: **方法1（検証マクロ）が最も簡単です**。既存マクロを一切変更しません。

---

## 今後の拡張

### より高度な制約を追加したい場合

1. `m制約検証.bas` に新しいチェックロジックを追加
2. `m負荷均し制約関数.bas` に新しい制約関数を追加
3. bas2sjisで変換してインポート

### パラメータ化

制約の厳しさをパラメータテーブルで調整可能にする：
- 号口単品の分散度
- 補給品の集中度
- 系列別の優先度

---

## まとめ

| 方法 | 難易度 | 既存変更 | 自動化 | 推奨度 |
|------|--------|----------|--------|--------|
| 方法1: 検証マクロ | ★☆☆ | なし | 半自動 | ★★★ |
| 方法2: 制約関数 | ★★☆ | なし | 手動 | ★☆☆ |
| 方法3: 完全版 | ★★★ | あり | 完全 | ★★☆ |

**初めての場合は方法1を推奨します。**

---

## 連絡先・サポート

- 制約検証マクロの使い方 → このREADME
- 制約関数の使い方 → `src/m負荷均し制約関数.bas` のコメント
- 完全版の作り方 → `docs/改修方針_負荷均しマクロ.md`
- エラーが出る → イミディエイトウィンドウの Debug.Print 出力を確認

---

**以上が最終納品物です。**

制約を追加した完全版マクロの作成は、既存マクロの規模（942行）から判断して現実的ではありませんでした。

代わりに、3つの選択肢を提供しました。最も簡単な「方法1：検証マクロ」を推奨します。
