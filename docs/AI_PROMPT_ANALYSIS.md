# AIプロンプト分析 - Excel不良集計マクロ生成

## 実行マクロ3（セット品）生成プロンプト

### 基本要件プロンプト
```
ExcelのVBAマクロを作成してください。

【マクロ名】
実行マクロ3

【対象シート】
「セット品」シート

【入力パラメータ】
- E1セル: 開始日付
- E2セル: 終了日付  
- E3セル: 自工程名（例：「モール」）
- E4セル: 流出先（カンマ区切り、例：「TG_TY,アルミ,ゴム」）
- J8:J11セル: アルヴェルの母数（合計）
- J12:J15セル: ノアヴォクの母数（合計）

【処理内容】
1. ピボットテーブル「ピボットテーブルS」を使って不良集計を実行
2. 以下4つのカテゴリで集計：
   - 自工程アルヴェル: E3工程で発見かつ発生した不良（アルヴェル）
   - 自工程ノアヴォク: E3工程で発見かつ発生した不良（ノアヴォク）
   - 流出アルヴェル: E3工程で発生し、E4の工程で発見された不良（アルヴェル）
   - 流出ノアヴォク: E3工程で発生し、E4の工程で発見された不良（ノアヴォク）

3. ピボットテーブルのフィルタ設定：
   - 自工程: 「発見2」と「発生」の両方をE3の値に設定
   - 流出: 「発生」をE3に、「発見2」をE4の値（複数可）に設定
   - 日付フィルタ: E1からE2の期間
   - アル/ノア: 各カテゴリに応じて設定

4. 出力形式：
   - 99行目: タイトル「[E3の値] 不良集計 [開始日]～[終了日]」
   - 100行目以降: 集計結果を配置
   - 左側に自工程、右側に流出を配置
   - 各テーブル下部に「母数」と「不良率」を表示
   - 不良率は「合計値÷母数×100」で計算（小数点3桁）
   - 6～98行を非表示化

5. 特殊処理：
   - 母数が0の場合は、事前定義された空テーブル（A81:D87、A91:D97）を使用
   - E4が空欄の場合は流出側の処理をスキップ
   - ピボットテーブルは降順でソート

【エラーハンドリング】
- On Error GoToによる例外処理
- Application設定の復元（ScreenUpdating、Calculation等）
- ステータスバーで進捗表示
```

### 技術的詳細を追加したプロンプト
```
上記に加えて、以下の技術要件を満たしてください：

【ピボットフィルタの実装】
- フィルタ設定時は「全アイテム表示→不要なものを非表示」の順で処理
- 最低1つのアイテムは常に表示状態を保つ（全滅回避）
- 発見2・発生フィールドは特に慎重に処理（エラー無視）
- 日付フィルタは CDate変換エラーを考慮

【コピー処理】
- TableRange1を使用してピボット全体をコピー
- 1行目は常に非表示化
- 2行目の下罫線を上罫線にも適用
- ShrinkToFit = Falseで文字サイズ固定

【デバッグ機能】
- Debug.Printで入力値とフィルタ状態を出力
- 処理の各段階でステータスバーを更新
```

---

## 実行マクロ4（単品）生成プロンプト

### 基本要件プロンプト
```
ExcelのVBAマクロを作成してください。

【マクロ名】
実行マクロ4

【対象シート】
「単品」シート

【入力パラメータ】
- E1セル: 開始日付
- E2セル: 終了日付
- E3セル: 自工程名（例：「モール」）
- E4セル: 流出先（カンマ区切り、例：「TG_TY,アルミ,ゴム」）
- J8:J15セル: 各分類の母数（8項目）

【処理内容】
1. ピボットテーブル「ピボットテーブルT」を使って不良集計を実行
2. 8つの分類で集計（各分類で自工程・流出の2セクション）：
   - アルヴェル Fr RH
   - アルヴェル Fr LH
   - アルヴェル Rr RH
   - アルヴェル Rr LH
   - ノアヴォク Fr RH
   - ノアヴォク Fr LH
   - ノアヴォク Rr RH
   - ノアヴォク Rr LH

3. ピボットテーブルのフィルタ設定：
   - 自工程: 「発見2」と「発生」の両方をE3の値に設定
   - 流出: 「発生」をE3に、「発見2」をE4の値（複数可）に設定
   - 日付フィルタ: E1からE2の期間
   - アル/ノア、Fr/Rr、RH/LH: 各分類に応じて設定

4. 出力形式：
   - 99行目: タイトル
   - 100行目以降: 8分類×2（自工程・流出）の集計結果
   - 左側に自工程、右側に流出を配置
   - 各テーブル下部に「母数」（J8-J15から対応する値）と「不良率」を表示
   - 6～98行を非表示化

5. 特殊処理：
   - 「モール×ノアヴォク」の組み合わせは処理をスキップ
   - 母数が0の場合は、事前定義された代替テーブル（A67:D97の範囲）を使用
   - E4が空欄の場合は流出側の処理をスキップ

【母数の対応】
- J8: アルヴェル Fr RH
- J9: アルヴェル Fr LH
- J10: アルヴェル Rr RH
- J11: アルヴェル Rr LH
- J12: ノアヴォク Fr RH
- J13: ノアヴォク Fr LH
- J14: ノアヴォク Rr RH
- J15: ノアヴォク Rr LH

【代替テーブルの対応】
- A67:D69: アルヴェル Fr RH用
- A71:D73: アルヴェル Fr LH用
- A75:D77: アルヴェル Rr RH用
- A79:D81: アルヴェル Rr LH用
- A83:D85: ノアヴォク Fr RH用
- A87:D89: ノアヴォク Fr LH用
- A91:D93: ノアヴォク Rr RH用
- A95:D97: ノアヴォク Rr LH用
```

### 技術的詳細を追加したプロンプト
```
上記に加えて、以下の技術要件を満たしてください：

【ループ処理】
- 8分類を配列で管理してループ処理
- 各分類で同じ処理パターンを適用
- 分類インデックス（0-7）で母数セルと代替テーブルを対応付け

【条件分岐】
- 3段階の条件判定：
  1. モール×ノアヴォクならスキップ
  2. 母数0なら代替テーブル使用
  3. それ以外は通常のピボット処理

【レイアウト】
- selfMaxWidthで自工程側の最大幅を記録
- destCol = selfMaxWidth + 2 で流出側の開始列を決定
- 各ブロック間は3行空ける
```

---

## 共通の最適化要件

両マクロに共通して指定すべき要件：

```
【パフォーマンス最適化】
- Application.ScreenUpdating = False
- Application.Calculation = xlCalculationManual
- Application.EnableEvents = False
- 処理終了時に必ず元に戻す

【ピボットテーブル操作】
- RefreshTableは必要最小限に
- ManualUpdate = Trueでソート時の再計算を抑制
- PivotItemsのVisible設定時はOn Error Resume Next

【エラーハンドリング】
- On Error GoTo CleanFailで一括処理
- CleanFailラベルで設定復元とエラーメッセージ表示
- Exit Subの前にCleanExitラベルで正常終了処理

【コードスタイル】
- Option Explicit宣言必須
- 変数は明示的に型宣言
- 日本語コメントで処理内容を説明
- インデント整形済み
```

## プロンプト作成のポイント

1. **具体的な入出力の明示**
   - セル位置、シート名、テーブル名を正確に指定
   - 期待する出力形式を詳細に説明

2. **処理ロジックの構造化**
   - 条件分岐を明確に（if-elseif-else）
   - ループ処理の対象と順序を指定

3. **エラー処理の要求**
   - ピボットフィルタの全滅回避
   - 母数0の場合の代替処理

4. **実装詳細の指定**
   - フィルタ設定の順序（全表示→選択的非表示）
   - コピー処理の詳細（罫線、書式）
   - 非表示行の設定

5. **デバッグ支援**
   - Debug.Print出力
   - ステータスバー表示
   - エラー時の詳細情報