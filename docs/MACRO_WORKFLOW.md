# 加工作業者別マクロ実行フロー

## 概要

このドキュメントは、加工作業者別データの集計・転記・分析を行う5つのマクロの実行フローを解説します。
これらのマクロは連携して動作し、日別データから最終的な集計表への転記まで一連の処理を自動化します。

## 全体フロー概要

```
日別データ → 集計 → 列準備 → 転記 → 分析 → 最終出力
```

## 処理ステップ詳細

### ステップ1: 日別集計処理
**マクロ名**: `m日別集計_加工作業者別`

**目的**: 加工工程の日別データを作業者ごとに集計

**処理内容**:
- ソース: シート「クエリ全工程」テーブル「_クエリ全工程」
- 対象工程: 「加工1」「加工2」のデータのみ
- 集計キー: 日付 + 作業者名
- 集計項目: 実績、不良、稼働時間、段取時間の合計値
- 出力先: シート「加工作業者別」テーブル「_加工作業者別a」

**実行タイミング**: 日次（データ更新時）

**出力例**:
```
日付       | 作業者 | 実績 | 不良 | 稼働時間 | 段取時間
2024/01/15 | 山田   | 120  | 2    | 7.5      | 0.5
2024/01/15 | 佐藤   | 98   | 1    | 6.8      | 0.3
```

---

### ステップ2: 作業者列名復元処理（月初のみ）
**マクロ名**: `m復元_作業者列名`

**目的**: 月初に作業者列名をA-J形式の標準形式にリセット

**処理内容**:
- 対象: シート「加工作業者別」テーブル「_加工作業者別b」
- 処理: 10スロット（A-J）× 8列パターン = 80列の列名を復元
- パターン: 稼働時間、実績、日時間当り出来高、日出来高ｻｲｸﾙ、累計、日平均実績、平均出来高ｻｲｸﾙ、平均時間当り数

**実行タイミング**: 月初またはデータリセット時

**復元例**:
```
復元前: 山田稼働時間, 佐藤実績, 田中日出来高ｻｲｸﾙ...
復元後: A稼働時間, B実績, C日出来高ｻｲｸﾙ...
```

---

### ステップ3: 動的列割り当て＋データ転記
**マクロ名**: `m転記_シート加工作業者別`

**目的**: 新規作業者の自動検出と空きスロットへの割り当て、データ転記

**処理内容**:
- ソース: テーブル「_加工作業者別a」（ステップ1の出力）
- ターゲット: テーブル「_加工作業者別b」
- 主要機能:
  1. 新規作業者の自動検出
  2. 空きスロット（A-J）への動的割り当て
  3. 稼働時間（稼働時間+段取時間）と実績の転記
  4. 日付ベースでの対応付け

**実行タイミング**: 日次（ステップ1実行後）

**処理例**:
```
1. 新規作業者「山田」を検出
2. 空きスロット「A」に割り当て
3. A稼働時間 → 山田稼働時間（8列一括変更）
4. 日付別にデータ転記
```

---

### ステップ4: 実績上位者抽出
**マクロ名**: `m転記_集計表_作業者名`

**目的**: 指定日付の実績上位5名の作業者名を抽出

**処理内容**:
- ソース: テーブル「_加工作業者別a」
- 基準日付: シート「集計表」セルA1
- 処理方法: 一時シートでソート処理実行
- 出力先: シート「集計表」セルD58, F58, H58, J58, L58

**実行タイミング**: 分析時（集計表更新時）

**処理フロー**:
```
1. 集計表A1から基準日付取得
2. 該当日付のデータを一時シートに抽出
3. 実績降順でソート
4. 上位5名を指定セルに転記
```

---

### ステップ5: 詳細指標転記
**マクロ名**: `m転記_集計表_加工作業者別`

**目的**: 上位作業者の詳細指標データを集計表に転記

**処理内容**:
- ソース: テーブル「_加工作業者別b」（ステップ3の出力）
- 作業者名取得元: シート「集計表」58行目（ステップ4の出力）
- 転記指標: 7種類（実績、日出来高ｻｲｸﾙ、日時間当り出来高、累計、日平均実績、平均出来高ｻｲｸﾙ、平均時間当り数）
- 出力先: シート「集計表」59-65行目（各指標ごとに行分け）

**実行タイミング**: 分析時（ステップ4実行後）

**転記例**:
```
58行目: 山田, 佐藤, 田中, 鈴木, 高橋（上位5名）
59行目: 120,  98,   87,   76,   65  （実績）
60行目: 2.5,  2.1,  1.9,  1.7,  1.5 （日出来高ｻｲｸﾙ）
...
```

## 実行順序とタイミング

### 日次処理
1. **m日別集計_加工作業者別** - 毎日のデータ集計
2. **m転記_シート加工作業者別** - 新規作業者対応とデータ転記

### 月初処理
1. **m復元_作業者列名** - 列名の標準化リセット
2. 日次処理を再開

### 分析時処理
1. **m転記_集計表_作業者名** - 上位者抽出
2. **m転記_集計表_加工作業者別** - 詳細データ転記

## データフロー

```
[クエリ全工程] 
    ↓ (日別集計)
[_加工作業者別a] 
    ↓ (動的割り当て+転記)
[_加工作業者別b] 
    ↓ (上位者抽出)
[集計表58行目] 
    ↓ (詳細転記)
[集計表59-65行目]
```

## 重要なポイント

### 新規作業者の自動対応
- ステップ3で新規作業者を自動検出
- A-Jスロットに動的割り当て
- 8列パターンを一括変更

### 月初リセットの重要性
- ステップ2で列名を標準形式に戻す
- 新しい月の作業者構成に対応
- データの整合性を保持

### エラー時の対処
- 各ステップで適切なエラーハンドリング
- Debug.Printによる警告出力
- ステータスバーでの進捗表示

## 運用上の注意点

1. **実行順序の遵守**: 各ステップは依存関係があるため順序を守る
2. **月初処理**: 月が変わったら必ずステップ2を実行
3. **データ整合性**: 各ステップ完了後にデータを確認
4. **エラー確認**: イミディエイトウィンドウで警告メッセージをチェック

---

*この文書は実際のマクロ動作に基づいて作成されています。運用時は各マクロのエラーメッセージとステータスバー表示を確認してください。*