# M言語クエリ解説: クエリ全工程

## 1. クエリの目的・概要

製造業の全工程における作業者別生産実績データの整理・集計クエリ。クエリ成形が機械・号機の稼働状況を分析するのに対し、このクエリは**作業者の作業状況**の分析に重点を置く。

**主な機能**
- 生産管理システムからダウンロードしたExcelファイルの読み込み
- 手作業・組立作業の実績データを集計（機械作業は対象外）
- 作業者別・品番別・工程別の実績分析
- **セット品番と単品品番の統一的な管理**（すべてセット換算で集計）
- 不良数や作業時間の適切な振り分け

**業務フロー上の位置づけ**
```
生産管理システム → Excelダウンロード → M言語クエリ → Excelマクロ → 工程別詳細分析
```

**出力データ**: 日付・製番・品番・工程・作業者の組み合わせごとの実績数量・不良数量・稼働時間・段取時間

## 2. 処理の流れ（ステップごと）

### ステップ1-3: データの読み込みと基本整形
```
ソース = Excel.Workbook(File.Contents("Z:\全社共有\生産管理課\生産実績データ\2506.xlsx"), null, true),
```
- 生産管理システムからダウンロードしたExcelファイルを読み込み
- Sheet1のデータを取得し、1行目をヘッダーとして設定

### ステップ4-5: データ型の設定と空白行の削除
```
変更された型 = Table.TransformColumnTypes(...)
削除された空白行 = Table.SelectRows(...)
```
- 各列のデータ型を適切に設定（日付、数値、テキストなど）
- 完全に空の行を削除してデータをクリーンアップ

### ステップ6: 機械コードのフィルタリング（手作業・組立作業の抽出）
```
フィルターされた行2 = Table.SelectRows(削除された空白行, each ([機械コード] = "" or [機械コード] = "TRRL")),
```
- **重要ポイント**: 機械コードが空白または"TRRL"のデータのみを抽出
- **業務背景**: これは**手作業や組立作業**を意味する
- **クエリ成形との違い**: 
  - クエリ成形：機械コードが空白でない、かつTRRLでない → **機械作業**
  - クエリ全工程：機械コードが空白またはTRRL → **手作業・組立作業**

### ステップ7: 日付の補正処理
```
日付列追加 = Table.AddColumn(フィルターされた行2, "日付", each
    // 0時より大きく8時以下の場合、前日の日付として扱う
    if 時刻部分 <> null and 時刻部分 > #time(0, 0, 0) and 時刻部分 <= #time(8, 0, 0) then
        Date.AddDays(作業日の日付, -1)
    else
        作業日の日付,
```
- **夜勤対応**: 深夜0時過ぎから朝8時までの作業は前日の実績として扱う
- 夜勤の実績が正しい日付に集計される

### ステップ8-10: 必要な列の選択と作業区分のフィルタ
```
削除された他の列 = Table.SelectColumns(...)
フィルターされた行 = Table.SelectRows(削除された他の列, each ([作業区分] = "加工完了" or [作業区分] = "段取完了")),
```
- 集計に必要な列だけを残す（**作業者列も残す**点がクエリ成形との違い）
- 「加工完了」と「段取完了」の実績のみを対象にする

### ステップ11-13: 1次グループ化と時間の振り分け
```
グループ化された行 = Table.Group(...)
追加された段取時間列 = Table.AddColumn(グループ化された行, "段取時間", each if [作業区分] = "段取完了" then [加工時間] else 0)
```
- 日付・製番・品番・工程・**担当者**・作業区分でグループ化
- 加工時間を分単位から時間単位に変換（÷60）
- 段取完了の時間を「段取時間」として別管理

### ステップ14-16: 2次グループ化（作業区分の統合）
```
グループ化された行1 = Table.Group(列名を変更, {"日付", "製番", "品番・図番", "工程略称", "担当者略称"}, ...)
```
- 作業区分を統合し、同一条件の加工時間と段取時間を合算
- **作業者情報を維持**することで、誰がどれだけ作業したかを追跡可能

### ステップ17-19: 実績数量ゼロの不良数移行処理
```
処理済みグループ = Table.Group(グループ化された行1, {"製番", "品番・図番", "工程略称"}, {
    // 実績数量が0の行の不良数を、実績数量が最大の行に移行
```
- **特殊処理**: 実績数量0でも不良数がある場合の処理
- 同じ製番・品番・工程の中で、実績数量が最大の行に不良数を移行
- 不良率の計算が正確になる

### ステップ20-22: セット品番と単品品番の統一処理
```
品番除外リスト = {"60050", "60080", "28030", ...}  // 34個のセット品番

調整済み行 = List.Transform(
    Table.ToRecords(#"名前が変更された列 "),
    (row) =>
        let
            isExcluded = List.AnyTrue(List.Transform(品番除外リスト, (exclusionItem) => Text.Contains(current品番, exclusionItem))),
            new実績 = if not isExcluded and current実績 <> null then current実績 / 2 else current実績,
            new不良 = if not isExcluded and current不良 <> null then current不良 / 2 else current不良
```

**重要な業務背景：セット品番と単品品番**
- **セット品番**（除外リスト内の34品番）:
  - 2個1セットで製造される品番
  - 既に「セット数」でカウントされている
  - **そのまま使用**（調整不要）
  
- **単品品番**（除外リスト外の品番）:
  - 1個ずつ製造される品番
  - 「個数」でカウントされている
  - **2で割ってセット換算**する必要がある

- **処理の意味**:
  - この処理により、すべての品番が**統一的にセット単位**で管理される
  - 生産計画や在庫管理で一貫した単位での分析が可能になる

### ステップ23: 最終フィルタリング
```
フィルターされた行1 = Table.SelectRows(最終調整済みテーブル, each ([日付] <> null))
```
- 日付がnullの行を除外して最終データを確定

## 3. 重要なポイント

### クエリ成形との根本的な違い

| 観点 | クエリ成形 | クエリ全工程 |
|------|-----------|------------|
| **分析対象** | 機械・号機の稼働状況 | 作業者の作業状況 |
| **機械コード** | 空白でない、かつTRRL以外（機械作業） | 空白またはTRRL（手作業・組立） |
| **最終出力** | 作業者情報なし | 作業者情報あり |
| **主な用途** | 機械稼働率分析、設備管理 | 労務管理、作業者別生産性分析 |

### セット品番管理の重要性
- 製造現場では「セット品」と「単品」が混在
- 統一的な管理のため、すべてを「セット単位」に換算
- 異なる品番間での生産性比較が可能に

### 手作業・組立作業に特化した分析
- 機械を使わない作業（手組立、目視検査など）を対象
- 作業者のスキルレベルや作業効率の分析に活用
- 人的リソースの最適配分に貢献

### 不良区分の文字列結合
- 複数の不良区分がある場合、「不良区分名+不良数」の形式で連結
- 例：「キズ3,変形2」のように表示
- 作業者別の不良傾向分析に活用可能

## 4. 最終的な成果物

このクエリを実行すると、以下の列を持つ集計テーブルが生成される：

| 列名 | 内容 | クエリ成形との違い |
|------|------|-----------------|
| 日付 | 実績日付（夜勤補正済み） | 同じ |
| 製番 | 製造番号 | 同じ |
| 品番 | 製品の品番（図番から変更） | 同じ |
| 工程 | 作業工程名 | 同じ |
| **作業者** | **担当者名** | **全工程のみ** |
| 実績 | 生産実績数量（**セット換算済み**） | 換算方法が異なる |
| 不良 | 不良数量（**セット換算済み**） | 換算方法が異なる |
| 稼働時間 | 実際の加工にかかった時間 | 同じ |
| 段取時間 | 機械の段取りにかかった時間 | 同じ |
| 不良区分 | 不良の種類と数量の詳細 | 同じ |

## 5. 活用例

このテーブルは以下のような分析に活用できる：

- **作業者別生産性分析**: 誰が効率的に作業しているか
- **作業者別不良率分析**: スキルアップが必要な作業者の特定
- **工程別必要人員の算出**: 各工程に何人必要か
- **セット品番の生産計画**: 統一単位での生産計画立案

クエリ成形が「設備をどう動かすか」を分析するのに対し、クエリ全工程は「人をどう配置するか」を分析するためのデータを提供する。

## 後続処理
このクエリで整形されたデータは、Excelマクロによってさらに工程別の詳細な分析・集計が行われる。

## 関連ファイル
- ソースコード: `src/クエリ全工程.txt`
- 解説作成Issue: #26
- 関連クエリ: [M言語クエリ解説_クエリ成形.md](./M言語クエリ解説_クエリ成形.md)