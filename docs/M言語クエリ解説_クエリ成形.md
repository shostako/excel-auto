# M言語クエリ「クエリ成形」の解説

## 1. このクエリの目的・概要

このクエリは、製造業の生産実績データを整理・集計するためのものです。

**主な機能:**
- Excelファイルから生産実績データを読み込む
- 作業日時を考慮した日付の調整
- 機械ごと・品番ごとの実績を集計
- 不良品情報の統合
- 射出成形特有の重複データの削除

最終的に、**日付・品番・機械コード**の組み合わせごとに、実績数量・不良数量・稼働時間・段取時間をまとめた分析しやすいデータを作成します。

## 2. 処理の流れ（ステップごと）

### ステップ1: データの読み込み（行2-3）
```
ソース = Excel.Workbook(File.Contents("Z:\全社共有\生産管理課\生産実績データ\2506.xlsx"), null, true)
```
- 共有フォルダにある「2506.xlsx」というExcelファイルを読み込みます
- ファイルの中の「Sheet1」シートを選択します

### ステップ2: データの型設定（行4-5）
- 最初の行を列名として設定
- 各列のデータ型を指定（日付は日付型、数値は数値型など）
- これにより、計算やフィルタリングが正確に行えるようになります

### ステップ3: 空白行の削除（行6）
- データが入っていない空の行を削除します
- これにより無駄なデータ処理を避けます

### ステップ4: 日付列の追加（行8-19）
**重要な処理**: 夜勤対応の日付調整
- 時刻が午前0時より後、午前8時までの作業は前日の日付として扱います
- 例：6月2日の午前3時の作業 → 6月1日の実績として記録
- これは夜勤（夜中の作業）を正しい日付で集計するための処理です

### ステップ5: 必要な列の選択とフィルタリング（行21-22）
- 分析に必要な9つの列だけを残します
- 「加工完了」と「段取完了」の作業のみを対象とします
- 機械コードが空白でない、かつ「TRRL」でないデータを選択

### ステップ6: 重複データの削除（行24-40）
**特殊処理**: SS01～SS05の射出成形機の重複削除

**業務背景：**
射出成形では、1回のショット（金型を閉じて樹脂を注入する1サイクル）で複数の製品が同時に作られます。例えば：
- 1つの金型に2個取り、4個取りなどの複数の製品が配置されている
- それぞれ異なる品番として管理されているが、実際は同じ金型で同時に生産される

**問題点：**
- 各品番ごとに実績データが記録されるため、同じ稼働時間・生産数が重複して記録される
- これらを単純に合計すると、実際の2倍、4倍の稼働時間・生産数になってしまう

**解決方法：**
- 本当に必要なのは「金型としての生産実績（ショット数）」
- そのため、同時生産される品番のうち1つだけを残し、他は削除
- 品番の文字列順で最初の1件を代表として採用

### ステップ7: データの集計（行42-71）
**メインの集計処理**
- 日付・品番・機械コードの組み合わせごとにデータをグループ化
- 各グループで以下を計算：
  - **実績数量**: 合計値
  - **不良数量**: 合計値
  - **段取時間**: 「段取完了」の加工時間を**時間単位**で合計（元データは分単位なので60で割る）
  - **稼働時間**: 「加工完了」の加工時間を**時間単位**で合計（元データは分単位なので60で割る）
  - **不良区分**: 不良の種類と数量を「種類1数量1,種類2数量2」の形式で記録

### ステップ8: 実績数量0の特殊処理（行73-115）
**複雑な処理**: 実績0のデータを他の行にマージ
- 同じ品番・機械で実績数量が0の行がある場合
- その不良数量と不良区分情報を、同じグループ内の実績数量が最も多い行に追加します
- これにより、不良品だけが発生した場合のデータも正しく集計されます

### ステップ9: 最終的な整形（行117-126）
- グループ化されたデータを展開
- 日付がnullのデータを除外
- 列の順序を整理
- 列名を短くわかりやすく変更：
  - 「品番・図番」→「品番」
  - 「機械コード」→「機械」
  - 「実績数量」→「実績」
  - 「不良数量」→「不良」

## 3. 重要なポイントの説明

### ポイント1: 夜勤対応
製造業では24時間稼働が一般的です。夜中の0時～8時の作業を前日の実績として扱うことで、1日の作業を正しく集計できます。

### ポイント2: 段取時間と稼働時間の区別
- **段取時間**: 機械の準備・調整にかかった時間（時間単位）
- **稼働時間**: 実際に製品を作っていた時間（時間単位）
これらを分けることで、生産効率の分析が可能になります。

### ポイント3: 不良品情報の詳細保持
単に不良数を合計するだけでなく、どんな種類の不良が何個発生したかを「不良区分」列に記録します。これにより品質改善の分析に役立ちます。

### ポイント4: 射出成形の特性への対応
射出成形機（SS01～SS05）では、1回のショットで複数品番を同時生産するため、機械の稼働実績を正確に把握するために重複データを除去しています。これにより、実際の機械稼働状況を正しく分析できます。

### ポイント5: 時間単位の統一
元データでは時間が「分」単位で記録されていますが、管理・分析のしやすさのため、最終的には「時間（h）」単位に変換して出力しています。

## 4. 最終的な成果物

このクエリを実行すると、以下の8列を持つテーブルが作成されます：

| 列名 | 内容 | 単位 |
|------|------|------|
| 日付 | 作業日（夜勤考慮済み） | - |
| 品番 | 製品の品番 | - |
| 機械 | 使用した機械のコード | - |
| 実績 | 生産した数量の合計 | 個 |
| 不良 | 不良品の数量の合計 | 個 |
| 稼働時間 | 実際の生産時間 | 時間(h) |
| 段取時間 | 準備・調整時間 | 時間(h) |
| 不良区分 | 不良の種類と数量の詳細 | - |

このデータを使うことで：
- 日別・機械別・品番別の生産実績を把握
- 機械の真の稼働率や生産効率の分析（射出成形の重複を除いた正確な数値）
- 不良品発生状況の把握と改善活動
- 段取時間の分析による生産性向上の検討
などが可能になります。

## 関連ファイル
- ソースコード: `src/クエリ成形.txt`
- 解説作成Issue: #24