# M言語クエリ「クエリ成形改訂」の解説（統合品番機能追加版）

## 1. 概要

製造業の成形工程における生産実績データを、日別・品番別・機械別に集計・整形するM言語クエリです。生産管理システムから出力された詳細なトランザクションデータを、分析可能な形式に変換します。

**🔥 新機能（改訂版）**: SS機械での同時多品番生産に対応する「統合品番機能」を実装。複数品番を"|"区切りで統合し、より正確な実績管理を実現しました。

## 2. 業務フロー

```
生産管理システム
    ↓ エクスポート（月次データ）
Excelファイル（生データ）
    ↓ Power Query実行
本クエリによる整形処理
    ├─ 夜勤時間帯の日付調整
    ├─ SS機械の重複削除【改良】
    │   └─ 統合品番の生成【新規】
    ├─ グループ化による集計
    ├─ 実績数量0行の統合
    └─ 統合品番の適用【新規】
    ↓
整形済みデータ（統合品番付き）
    ↓ Excelマクロ処理
日別集計表・グラフ・分析レポート
```

## 3. 主要処理の詳細解説

### 3.1 データソースの読み込み（行1-34）
```m
// ===== データソース読み込み =====
ソース = Excel.Workbook(File.Contents("Z:\全社共有\生産管理課\生産実績データ\2506.xlsx"), null, true),
Sheet1_Sheet = ソース{[Item="Sheet1",Kind="Sheet"]}[Data],
昇格されたヘッダー数 = Table.PromoteHeaders(Sheet1_Sheet, [PromoteAllScalars=true]),

// ===== データ型変換 =====
変更された型 = Table.TransformColumnTypes(昇格されたヘッダー数,{...}),

// ===== 空白行削除 =====
削除された空白行 = Table.SelectRows(変更された型, each not List.IsEmpty(List.RemoveMatchingItems(Record.FieldValues(_), {"", null})))
```

**処理内容**：
- 共有フォルダ上の月次実績ファイルを読み込み
- 22列のデータを適切な型（日付、数値、テキスト）に変換
- 空白行を効率的に削除（全フィールドが空またはnullの行を除外）

### 3.2 夜勤対応の日付調整（行36-48）
```m
// ===== 日付列追加（夜勤対応：0時-8時のデータは前日扱い） =====
日付列追加 = Table.AddColumn(削除された空白行, "日付", each
    let
        dateTimeValue = try DateTime.From([時刻]) otherwise null,
        作業日の日付 = [作業日],
        時刻部分 = if dateTimeValue <> null then DateTime.Time(dateTimeValue) else null
    in
    // 時刻部分が取得でき、かつ0時より大きく8時以下の場合は前日扱い
    if 時刻部分 <> null and 時刻部分 > #time(0, 0, 0) and 時刻部分 <= #time(8, 0, 0) then
        Date.AddDays(作業日の日付, -1)
    else
        作業日の日付,
type date)
```

**処理内容**：
- 午前0時～8時の作業実績は前日の日付として扱う
- 例：6月2日午前3時の作業 → 6月1日の実績として記録
- 24時間稼働の製造現場での夜勤シフトに対応

### 3.3 SS機械の重複削除処理と統合品番機能【大幅改良】（行62-101）

#### 3.3.1 基本的な考え方
SS機械（SS01～SS05）では、同時に複数の品番を生産する場合があり、システム上は同じ時刻・同じ数量で複数の品番が記録されます。これを適切に処理するため、以下の高度な処理を実装しています。

```m
// ===== 重複削除処理（修正版） =====
重複削除済み行 = let
    // SS系機械（SS01-SS05）とそれ以外に分離
    SS行 = Table.SelectRows(フィルターされた行, each 
        ([機械コード] = "SS01" or [機械コード] = "SS02" or 
         [機械コード] = "SS03" or [機械コード] = "SS04" or [機械コード] = "SS05")
    ),
    非SS行 = Table.SelectRows(フィルターされた行, each 
        ([機械コード] <> "SS01" and [機械コード] <> "SS02" and 
         [機械コード] <> "SS03" and [機械コード] <> "SS04" and [機械コード] <> "SS05")
    ),
```

#### 3.3.2 統合品番の生成【新機能】
```m
    // SS行の重複削除：機械コード・実績数量・時刻でグループ化
    // ※同一機械・同一数量・同一時刻で複数品番がある場合、代表品番を残し、統合品番列を追加
    重複削除済みSS行 = Table.FromRecords(
        List.Transform(
            // グループ化：機械コード + 実績数量 + 時刻
            Table.Group(SS行, {"機械コード", "実績数量", "時刻"}, {{"GroupData", each _, type table}})[GroupData],
            each 
                let
                    グループテーブル = _,
                    // グループ内の全品番を昇順ソートして取得
                    品番リスト = Table.Column(Table.Sort(グループテーブル, {{"品番・図番", Order.Ascending}}), "品番・図番"),
                    // 品番を"|"で連結して統合品番を作成
                    統合品番 = Text.Combine(品番リスト, "|"),
                    // 代表レコード（先頭1件）を取得
                    代表レコード = Table.First(Table.Sort(グループテーブル, {{"品番・図番", Order.Ascending}})),
                    // 統合品番列を追加（品番・図番は代表品番のまま保持）
                    最終レコード = Record.AddField(代表レコード, "統合品番", 統合品番)
                in
                    最終レコード
        )
    ),
```

**🔥 統合品番機能の詳細**：
- **グループ化キー**: 機械コード + 実績数量 + 時刻（3次元グループ化）
- **品番統合ロジック**:
  1. グループ内の全品番を昇順でソート
  2. 品番を"|"区切りで連結（例：`A001|B002|C003`）
  3. 代表レコードは品番昇順の先頭を選択
  4. 統合品番を新列として追加

#### 3.3.3 非SS機械との統合
```m
    // SS行（重複削除済み）と非SS行を結合
    // 非SS行には統合品番列がないため、品番・図番をコピーして統合品番列を追加
    非SS行_統合品番追加 = Table.AddColumn(非SS行, "統合品番", each [#"品番・図番"]),
    結合結果 = Table.Combine({非SS行_統合品番追加, 重複削除済みSS行})
in
    結合結果,
```

**処理内容**：
- 非SS機械のデータには、品番・図番をそのまま統合品番として設定
- 全データに統合品番列が存在する状態を作成

### 3.4 メイン集計処理（行103-144）
```m
// ===== メイン集計処理 =====
// グループ化：日付 + 品番 + 機械コード単位で各種数値を集計
統合グループ化 = Table.Group(重複削除済み行, {"日付", "品番・図番", "機械コード"}, {
    // 実績数量の合計
    {"実績数量", each List.Sum([実績数量]), type nullable number},
    // 不良数量の合計
    {"不良数量", each List.Sum([不良数量]), type nullable number},
    // 段取時間：「段取完了」の加工時間合計（秒→分変換）
    {"段取時間", each ... },
    // 稼働時間：「加工完了」の加工時間合計（秒→分変換）
    {"稼働時間", each ... },
    // 不良区分の統合：「不良区分略称 + 不良数量」をカンマ区切りで連結
    {"不良区分", each ... },
    // 統合品番の保持：グループ内の最初の統合品番を取得
    {"統合品番", each List.First([#"統合品番"]), type nullable text}
})
```

**改良点**：
- 統合品番列を集計結果に保持
- グループ化は品番・図番ベースで実施（統合品番の適用は最終段階）

### 3.5 実績数量0行の統合処理（行146-200）
```m
// ===== 実績数量0行のマージ処理 =====
// 品番・機械コード単位で、実績数量0の行の不良情報を実績数量>0の行にマージ
処理済みグループ = Table.Group(統合グループ化, {"品番・図番", "機械コード"}, {
    {"ProcessedData", (currentGroupTable as table) =>
        let
            // 実績数量0の行と0以外の行に分離
            zero実績行 = Table.SelectRows(currentGroupTable, each [実績数量] = 0),
            nonZero実績行 = Table.SelectRows(currentGroupTable, each [実績数量] <> 0),
            
            // ... 不良情報の統合処理 ...
        in
            resultTable, type table}
})
```

**処理内容**：
- 実績数量が0の行（不良品のみ発生）を、同じ品番・機械の実績がある行に統合
- 統合先は実績数量が最も多い行を選択
- 不良数量は加算、不良区分はカンマ区切りで結合

### 3.6 統合品番の最終適用【新機能】（行212-216）
```m
// 品番・図番列を統合品番で置き換え（重複削除情報を最終出力に反映）
// 古い品番・図番列を削除 → 統合品番列を品番・図番にリネーム
品番列削除 = Table.RemoveColumns(フィルターされた行1, {"品番・図番"}),
統合品番適用 = Table.RenameColumns(品番列削除, {{"統合品番", "品番・図番"}}),
```

**🔥 最終適用の意義**：
- SS機械で同時生産された複数品番が"|"区切りで表示される
- 例：`A001|B002` → 同時に生産された品番A001とB002
- 後続の分析で、同時生産の実態を正確に把握可能

### 3.7 最終整形処理（行218-230）
```m
// 列順序調整
並べ替えられた列 = Table.ReorderColumns(統合品番適用,{
    "日付", "品番・図番", "機械コード", "実績数量", "不良数量", "稼働時間", "段取時間", "不良区分"
}),
// 列名変更（表示用）
列名変更 = Table.RenameColumns(並べ替えられた列,{
    {"品番・図番", "品番"}, 
    {"機械コード", "機械"}, 
    {"実績数量", "実績"}, 
    {"不良数量", "不良"}
})
```

## 4. 技術的なポイント

### 4.1 高度なM言語テクニック

#### 4.1.1 3次元グループ化
旧版の2次元（実績数量×時刻）から、新版では3次元（機械コード×実績数量×時刻）へ進化。より精密な重複判定が可能に。

#### 4.1.2 動的な列生成
`Record.AddField`を使用して、既存レコードに統合品番列を動的に追加。型安全性を保ちながら柔軟な処理を実現。

#### 4.1.3 List変換の活用
```m
List.Transform(
    Table.Group(...)[GroupData],
    each let ... in 最終レコード
)
```
グループ化結果を効率的に変換し、メモリ効率の良い処理を実現。

### 4.2 エラーハンドリングと堅牢性
- `try ... otherwise` 構文による安全な型変換
- null値チェックによる不正データの除外
- 条件付き処理による柔軟なデータ処理

### 4.3 パフォーマンス最適化
- 早期のフィルタリングで処理対象データを削減
- グループ化処理の統合により、複数回のテーブルスキャンを回避
- List関数の活用による効率的な集計

### 4.4 保守性の向上
- セクションごとのコメント追加により、処理の意図が明確
- 変数名の日本語化により、業務担当者にも理解しやすい
- モジュール化された処理構造

## 5. 後続処理との連携

### 5.1 出力データ形式
最終的に以下の8列を持つテーブルが出力されます：
- **日付**: 夜勤調整済みの作業日
- **品番**: 製品識別番号（統合品番形式：`A001|B002`）
- **機械**: 加工機械コード
- **実績**: 生産数量の合計
- **不良**: 不良数量の合計
- **稼働時間**: 実際の加工時間（分）
- **段取時間**: 準備・調整時間（分）
- **不良区分**: 不良理由と数量の一覧

### 5.2 統合品番の業務的意義

#### 5.2.1 SS機械の特殊性への対応
- **同時多品番生産**: 1つの金型で複数品番を同時成形
- **実績の一体性**: 分離不可能な生産実績を適切に表現
- **原価計算への貢献**: 共通コストの按分基準として活用可能

#### 5.2.2 分析での活用例
```
品番: A001|B002|C003
実績: 1000
→ 3品番で1000個を同時生産
→ 各品番の按分計算が可能
```

### 5.3 Excelマクロとの連携
このクエリの出力は、以下のようなExcelマクロで利用されます：
- **日別集計マクロ**: 統合品番を考慮した集計
- **品番別分析マクロ**: 統合品番の分解処理を含む分析
- **機械別稼働率マクロ**: SS機械の特殊性を反映した稼働率算出
- **原価計算マクロ**: 統合品番の按分処理

### 5.4 更新と保守

#### 5.4.1 設定変更箇所
- **ファイルパス**: 3行目の`File.Contents`のパス
- **夜勤時間**: 44行目の時間判定ロジック（現在は0:00-8:00）
- **SS機械の追加**: 66-71行目の機械コード判定条件
- **統合品番の区切り文字**: 86行目の`Text.Combine`の第2引数（現在は"|"）

#### 5.4.2 拡張ポイント
- 新しい集計項目の追加：104行目からの統合グループ化処理
- 品番統合ルールの変更：79-93行目の統合品番生成ロジック
- 不良区分の集計方法：127-141行目の不良区分統合処理

## 6. まとめ

この改訂版クエリは、製造現場の複雑な要件（特にSS機械での同時多品番生産）に対応しながら、データの正確性と分析の柔軟性を両立させています。統合品番機能により、従来は表現できなかった生産実態を正確に記録し、後続の分析精度を大幅に向上させることが可能となりました。

技術的には、M言語の高度な機能を活用しつつ、可読性と保守性を確保した実装となっており、製造業のデータ処理における実践的なベストプラクティスを示しています。