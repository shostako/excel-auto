# Claude Codeサブエージェント ベストプラクティス

**作成日**: 2025-11-07
**対象**: excel-autoプロジェクト開発
**根拠**: 実証実験による検証（SUBAGENT_VERIFICATION_REPORT.md参照）

---

## クイックスタート

### いつサブエージェントを使うべきか？

```
大規模な調査が必要？
├─ Yes → Exploreサブエージェント
└─ No
   └─ 複雑な実装計画が必要？
      ├─ Yes → Planサブエージェント
      └─ No → 直接実行（Grep/Read/Glob）
```

---

## 1. Exploreサブエージェント

### 1.1 使うべき場面

✅ **推奨**:
- コードベース全体の構造を把握したい
- 特定機能に関連するファイルを網羅的に探したい
- 複数ディレクトリをまたぐ調査
- メイン会話のコンテキストを節約したい

❌ **非推奨**:
- 特定ファイルの内容を読むだけ（Readで十分）
- ファイル名が既に分かっている（Globで十分）
- 単純なキーワード検索（Grepで十分）

### 1.2 thoroughnessレベルの使い分け

| レベル | 用途 | 処理時間 | 推奨モデル |
|--------|------|----------|-----------|
| **quick** | 基本的な検索、ファイル一覧 | 数秒 | haiku |
| **medium** | 中程度の探索、パターン分析 | 数十秒 | haiku/sonnet |
| **very thorough** | 包括的な分析、詳細調査 | 数分 | sonnet |

**実測データ**:
- quick: 2-3秒、約10ステップ、2,000トークン（メイン会話）
- very thorough: 10分、30+ファイル読み込み、5,000トークン（メイン会話）

### 1.3 効率の最大化

**コンテキスト節約の効果**:
- サブエージェント内部: 58,000トークン消費
- メイン会話: 5,375トークンのみ増加
- **効率比: 10.8倍**

**使い分けの基準**:
```
調査の複雑さ × ファイル数 > 閾値
    ├─ True → Exploreサブエージェント（効率的）
    └─ False → 直接実行（速い）

閾値の目安:
- ファイル数 > 5個
- または複数ディレクトリ
- またはパターン分析が必要
```

---

## 2. Planサブエージェント

### 2.1 使うべき場面

✅ **推奨**:
- 新機能の実装計画を立てたい
- 複雑なリファクタリングの手順を整理したい
- アーキテクチャの変更を検討したい
- 複数の実装選択肢を比較したい

❌ **非推奨**:
- 単純なコード修正（直接実装で十分）
- 既に計画が明確なタスク

### 2.2 Planサブエージェントの特性

**できること**:
- 既存コードの調査（Glob/Grep/Read使用）
- 複数の実装選択肢の比較
- 段階的な実装手順の提案
- リスク分析

**できないこと**:
- 他のサブエージェントの呼び出し（Exploreなど）
- 実際のコード実装（Plan modeのため）

**重要**: Planサブエージェント自身がGlob/Grep/Readを使って調査するため、大規模な調査が必要な場合は**事前にExploreサブエージェントで調査**してから、その結果をPlanに渡す方が効率的。

---

## 3. 並列実行

### 3.1 並列実行のメリット

**実測データ**:
- 4つのサブエージェント同時実行
- 従来方法（順番実行）: 約20,000トークン
- 並列実行: 10,890トークン
- **効率比: 1.8倍**

### 3.2 並列実行の推奨パターン

**推奨**: 独立した調査タスクを同時実行
- ドキュメント構造の探索
- コード実装の探索
- テスト体系の探索
- 依存関係の分析

**非推奨**: 依存関係があるタスクの並列実行
- 調査結果に基づく計画立案（順次実行が必要）

---

## 4. 実践的なワークフロー

### 4.1 新機能開発のワークフロー

```
Step 1: 既存実装の調査（Explore）
└─ thoroughness: medium
└─ model: haiku

Step 2: 実装計画の立案（Plan）
└─ Exploreの結果を参照
└─ model: sonnet

Step 3: 実装開始
└─ 直接コーディング
```

### 4.2 大規模リファクタリングのワークフロー

```
Step 1: 並列調査（4x Explore）
├─ コードベース構造
├─ 依存関係
├─ テスト体系
└─ ドキュメント状況

Step 2: 包括的計画（Plan）
└─ 4つのレポートを統合
└─ 段階的な実装手順を提案

Step 3: 段階的実装
└─ Phaseごとに実装・テスト
```

### 4.3 緊急バグ修正のワークフロー

```
緊急度が高い場合: サブエージェント不使用
└─ 直接Grep/Readで原因特定
└─ 即座に修正

緊急度が低い場合: Explore活用
└─ 関連コード全体を調査
└─ 根本原因を特定
└─ 再発防止策を含めて修正
```

---

## 5. アンチパターン

### 5.1 やってはいけないこと

❌ **単純なファイル読み込みでサブエージェントを使う**
```
悪い例:
「src/マクロ名.basの内容を確認してください」
→ Readで十分
```

❌ **毎回very thoroughを使う**
```
悪い例:
全てのタスクでthoroughness: very thorough
→ 不要なコスト増加
```

❌ **サブエージェント結果を無視して再調査**
```
悪い例:
Exploreの結果があるのに、また別のExploreを起動
→ 重複調査
```

### 5.2 よくある間違い

**間違い1**: Planサブエージェントが他のサブエージェントを呼べると期待
**正解**: 事前にExploreで調査してから、その結果をPlanに渡す

**間違い2**: 並列実行を避ける
**正解**: 独立したタスクは積極的に並列実行

**間違い3**: コンテキスト節約を意識しない
**正解**: 大規模調査ではサブエージェントを優先

---

## 6. トークン消費の最適化

### 6.1 実測ベースの指針

| タスク | 方法 | トークン消費 |
|--------|------|-------------|
| 単純ファイル読み込み | Read | ~500 |
| 3-5ファイルの調査 | 直接実行 | ~3,000 |
| 10+ファイルの調査 | Explore (quick) | ~2,000（メイン） |
| 包括的分析 | Explore (very thorough) | ~5,000（メイン） |
| 並列調査（4タスク） | 4x Explore (medium) | ~11,000（メイン） |

### 6.2 コスト削減の実践例

**ケース1**: ドキュメント構造の把握
```
従来方法: ls, tree, Read x 10 → 8,000トークン
サブエージェント: Explore (medium) → 2,500トークン
削減率: 68.8%
```

**ケース2**: 最適化パターン適用状況
```
従来方法: Glob, Grep, Read x 3, 分析 → 5,570トークン
サブエージェント: Explore (quick) → 2,269トークン
削減率: 59.3%
```

---

## 7. 具体的なプロンプト例

### 7.1 Exploreサブエージェント

#### パターン1: ファイル探索
```
このプロジェクトで、[機能名]に関連するファイルを全て見つけてください。

調査対象:
- [ディレクトリ1]
- [ディレクトリ2]

thoroughness: [quick/medium/very thorough]

最終レポートには以下を含めてください:
- 見つかったファイルのリスト（パス付き）
- 各ファイルの役割
- [機能名]の実装パターン
```

#### パターン2: パターン分析
```
このプロジェクトで[パターン名]がどのように使われているか分析してください。

分析対象:
- 適用状況（どのファイルでどう使われているか）
- 適用率（全体の何%で使用されているか）
- 未適用箇所の特定

thoroughness: medium

最終レポートには適用状況と改善提案を含めてください。
```

### 7.2 Planサブエージェント

#### パターン1: 新機能実装
```
[プロジェクト名]に[機能名]を追加する実装計画を立ててください。

要件:
- [要件1]
- [要件2]

制約:
- [制約1]
- [制約2]

最終レポートには以下を含めてください:
- アーキテクチャ設計
- 実装手順（Phase分け）
- 既存コードへの影響分析
- テスト計画
- リスク評価
```

---

## 8. トラブルシューティング

### 8.1 サブエージェントが期待通り動かない

**症状**: レポートが浅い、必要な情報が不足
**原因**: thoroughnessレベルが低すぎる、またはプロンプトが曖昧
**対策**:
- thoroughnessをmedium/very thoroughに変更
- プロンプトに具体的な調査項目を列挙

### 8.2 処理時間が長すぎる

**症状**: サブエージェントが数分経っても完了しない
**原因**: very thoroughで大規模コードベースを調査
**対策**:
- thoroughnessをmediumに下げる
- 調査対象を絞り込む（特定ディレクトリのみ）

### 8.3 メイン会話のトークンが逼迫

**症状**: コンテキストウィンドウが埋まってきた
**原因**: サブエージェントを使わず直接実行を多用
**対策**:
- 大規模調査はExploreサブエージェントに委任
- 並列実行で効率化

---

## 9. excel-auto プロジェクト専用の推奨事項

### 9.1 VBAマクロ開発での活用

**推奨ワークフロー**:
1. 参考マクロの分析 → Explore (medium)
2. 最適化パターン適用確認 → Explore (quick)
3. 新マクロ実装計画 → Plan (sonnet)
4. 実装 → 直接コーディング

### 9.2 ドキュメント整備での活用

**推奨ワークフロー**:
1. ナレッジベース構造分析 → Explore (medium)
2. 重複・欠落の特定 → Explore (medium)
3. 改善計画 → Plan (sonnet)
4. ドキュメント作成 → 直接編集

### 9.3 エンコーディング問題の調査

**推奨ワークフロー**:
1. 関連ファイルの探索 → Explore (quick)
2. 変換フロー全体の把握 → Explore (medium)
3. 問題の原因特定 → 直接Read/Grep

---

## 10. まとめ

### 10.1 黄金律

1. **大規模調査はサブエージェントに委任** - 10.8倍の効率化
2. **独立タスクは並列実行** - 1.8倍の効率化
3. **簡単なタスクは直接実行** - 速度優先
4. **thoroughnessは適切に設定** - コスト vs 品質
5. **Planの前にExplore** - 効率的な計画立案

### 10.2 効果の実測値

- **小規模調査**: 2.45倍の効率化
- **大規模調査**: 10.8倍の効率化
- **並列実行**: 1.8倍の効率化

### 10.3 次のステップ

このベストプラクティスを実践しながら、プロジェクト固有のパターンを蓄積していく：
- 効果的だったプロンプトを記録
- thoroughnessレベルの最適値を発見
- 並列実行の組み合わせパターンを確立

---

**参照**: SUBAGENT_VERIFICATION_REPORT.md（詳細な検証結果）
