# ハモコ内示表PDF自動読込 - Power Query設定手順

## 概要

「【内示表】ハモコ・ジャパン_YYMMDD-X.pdf」を自動的に読み込み、日別数量データをテーブル化するPower Queryクエリの設定手順。

## 前提条件

- Excel 2016以降（Power Query搭載版）
- PDFファイルの保存先：`Z:\全社共有\生産管理課\生産管理\受注`
- ファイル名パターン：`【内示表】ハモコ・ジャパン_*.pdf`

## 初回設定手順

### 1. 最初のPDF手動読み込み

1. Excelを開く
2. **データタブ** → **データの取得** → **ファイルから** → **PDFから**
3. 任意のハモコ内示表PDFを選択
4. ナビゲーターで表示されるテーブル一覧を確認
5. **データの変換**をクリック（Power Queryエディタが開く）

### 2. 列構造の確認

Power Queryエディタで以下を確認：

- **Column1**: 品番（08611-58070など）
- **Column2**: 品名
- **Column9**: 車種
- **Column10**: 始期
- **Column11**: 終期
- **Column12**: 納入単位
- **Column13**: 当月注文数
- **Column14**: 翌月内示数
- **Column15**: 翌々月内示数
- **Column16～Column46**: 1日～31日の数量

**※列番号がずれている場合は、M言語の列番号を修正する必要がある**

### 3. M言語クエリの適用

1. Power Queryエディタで **ホーム** → **詳細エディタ**
2. 表示されたM言語を全て削除
3. `src/PDF_ハモコ内示表_自動読込.pq` の内容をコピペ
4. **完了**をクリック

### 4. エラーが出た場合の調整

#### ケース1: 列番号がずれている

M言語の以下の部分を修正：

```m
ProductInfo = Table.SelectColumns(ProductRows,
    {"Column1", "Column2", "Column9", "Column10", "Column11", "Column12",
     "Column13", "Column14", "Column15", "Index"}),
```

実際の列番号に合わせて変更。

#### ケース2: 日別数量の列範囲が違う

```m
AddDay = Table.AddColumn(UnpivotQuantity, "日付",
    each Number.From(Text.AfterDelimiter([日], "Column")) - 15),
```

この`-15`の部分を調整。
- Column16が1日の場合：`-15`
- Column17が1日の場合：`-16`

#### ケース3: PDFページの構造が違う

```m
RemoveHeaders = Table.Skip(AllPages, each not Text.Contains(Text.From([Column1]), "08")),
```

品番の先頭文字（"08"）を実際のパターンに変更。

### 5. クエリの読み込み

1. **ホーム** → **閉じて読み込む** → **閉じて次に読み込む**
2. **テーブル**を選択
3. 配置先シートを指定
4. **OK**

### 6. VBAボタンの作成（オプション）

シートにボタンを配置して、ワンクリックで更新できるようにする。

#### VBAマクロ

```vba
Sub ハモコ内示表更新()
    Application.StatusBar = "PDF読み込み中..."

    On Error GoTo ErrorHandler

    ' クエリ名を指定（実際の名前に変更）
    ThisWorkbook.Connections("PDF_ハモコ内示表_自動読込").Refresh

    Application.StatusBar = False
    MsgBox "更新完了", vbInformation
    Exit Sub

ErrorHandler:
    Application.StatusBar = False
    MsgBox "エラーが発生しました: " & Err.Description, vbCritical
End Sub
```

#### ボタン配置

1. **開発タブ** → **挿入** → **ボタン（フォームコントロール）**
2. シート上でドラッグして配置
3. マクロ選択で`ハモコ内示表更新`を指定
4. ボタンのテキストを「内示表更新」などに変更

## 運用方法

### 通常使用

1. 新しいPDFが`Z:\全社共有\生産管理課\生産管理\受注`に保存される
2. Excelを開く
3. **ボタンをクリック**（または**データタブ** → **すべて更新**）
4. 自動的に最新PDFを読み込んでテーブル更新

### フォルダパスを変更したい場合

M言語の冒頭部分を修正：

```m
let
    // ========== 設定 ==========
    // フォルダパス（必要に応じて変更）
    FolderPath = "Z:\全社共有\生産管理課\生産管理\受注",  // ← ここを変更
```

### ファイル名パターンを変更したい場合

```m
    // ファイル名パターン（ハモコの内示表PDFのみ対象）
    FileNamePattern = "【内示表】ハモコ・ジャパン",  // ← ここを変更
```

## トラブルシューティング

### エラー: "列が見つかりません"

→ PDF構造が変わった可能性。手動で1回読み込んで列番号を確認し、M言語を修正。

### エラー: "ファイルが見つかりません"

→ フォルダパスまたはファイル名パターンを確認。

### データが重複している

→ 品番行と数量行のペアリングがずれている。`Number.Mod([Index], 2)`の部分を確認。

### 日付がずれている

→ `- 15`の調整値を変更。実際のColumn番号と日付の対応を確認。

## 注意事項

- PDFのレイアウトが大きく変わると、M言語の全面的な見直しが必要
- スキャンPDFには対応していない（テキストデータが必須）
- 複数の取引先で同じクエリを使い回す場合は、ファイル名パターンとフォルダパスをパラメータ化することを推奨

## 応用：複数取引先対応

複数の取引先PDFを一つのテーブルに統合したい場合：

1. 取引先ごとに別々のクエリを作成
2. 「クエリのマージ」で統合
3. 「取引先名」列を追加して識別

詳細は別途相談。
