# 負荷均しマクロ - 既知の課題

**作成日**: 2025-10-28
**バージョン**: v0.1-負荷均し-基本動作版

---

## 緊急度：高（動作不良）

### 課題4: 休日設定が反映されない

**現象**:
- 休日であるはずの日に生産数が割り当てられている
- 稼働日算出ロジックは正常に動作（ログ出力では正しい稼働日が表示される）
- 日次割り当てループで休日チェックが機能していない

**原因推測**:
- 稼働日配列を使わず、1〜31日を直接ループしてる可能性
- 稼働日配列のインデックスと日付の対応が誤っている可能性

**影響**:
- 休日に生産計画が組まれる
- 実運用不可能

**対応方針**:
1. 日次割り当てループを稼働日配列ベースに修正
2. 転記時に稼働日チェックを追加
3. テスト: 休日が含まれる月で検証

---

## 緊急度：高（仕様不足）

### 課題1: 型番単位の上限管理未実装

**背景**:
- アルヴェル系列（62-58040/50/60）
- ノアヴォク系列（62-28030/40/50/60）
- これらは複数の品番が同じ型番（金型）を共有

**現状の問題**:
- 品番ごとの「上限」しか管理していない
- 型番（金型）単位の1日生産数上限が考慮されていない
- 結果: 同じ型番の品番が同日に複数割り当てられ、物理的な生産能力を超過

**要件**:
- 品番ごとの上限 + 型番ごとの上限の両方を管理
- 同一型番の品番合計が型番上限を超えないようにする

**実装案**:
1. テーブル「_品番」に「型番上限」列を追加（または別テーブル「_型番上限」）
2. 日次割り当て時に以下をチェック:
   - 品番単位の上限
   - 型番単位の上限（同一型番品番の当日割り当て合計）
3. 上限計算式:
   ```
   割り当て可能数 = Min(
       品番上限 - 品番の当日既割り当て,
       型番上限 - 型番の当日既割り当て合計,
       その他の制約...
   )
   ```

**テーブル設計案**:

#### 案A: 既存テーブルに列追加
```
テーブル「_品番」
{成形品番, 型番, セット, グループ, 仕様, 単位, 上限, 型番上限, 優先度}
```
- メリット: シンプル
- デメリット: 型番上限が重複記述される

#### 案B: 別テーブル管理（推奨）
```
テーブル「_型番上限」
{型番, 上限}

例:
S01 | 500
S02 | 600
S03 | 400
```
- メリット: 正規化、一元管理
- デメリット: テーブルが増える

---

## 緊急度：中（仕様不足）

### 課題2: 週単位の負荷分散未実装

**現象**:
- アルヴェル系列、ノアヴォク系列が優先度1（最優先）
- 上限が大きいため、月初の稼働日に集中的に割り当てられる
- 結果: 当月最初の週に全く生産がない品番が発生

**要件**:
- 主力成形品番（アルヴェル/ノアヴォク系列）は毎週ある程度納品できるように分散
- 納期も考慮（納期が近い品番を優先）

**実装案**:

#### 案A: 週単位の割り当て制約
```
1. 月を週単位に分割（第1週、第2週、...）
2. 各週ごとに主力品番を必ず割り当てる
3. 週内での日次割り当ては既存ロジック
```

#### 案B: 納期優先割り当て
```
1. テーブル「_成形展開」の納期情報を取得
2. 納期が近い品番を優先的に割り当て
3. 同一優先度内で納期順にソート
```

#### 案C: 分散係数導入
```
1. テーブル「_品番」に「分散フラグ」列追加
2. 分散フラグ=TRUEの品番は月全体に均等分散
3. 週ごとの割り当て上限を設定
```

**推奨**: 案B（納期優先）+ 案C（分散係数）の組み合わせ

**テーブル改修**:
```
テーブル「_品番」に列追加:
{..., 分散フラグ, 週間上限}

分散フラグ: TRUE/FALSE（主力品番はTRUE）
週間上限: この品番の1週間あたりの上限数
```

---

## 緊急度：低（発展機能）

### 課題3: 手動微調整機能未実装

**要件**:
- マクロ実行後の結果を受けて、特定の品番の日程を手動で調整したい
- 操作イメージ:
  1. グループIDを指定
  2. 移動先の日付を指定
  3. マクロ実行で日程を「ずらす」

**実装案**:

#### 機能A: グループ日程移動
```
Sub 日程ずらし_グループ(グループID As String, 移動元日 As Long, 移動先日 As Long)
    ' 指定グループのすべての品番を移動元日→移動先日に移動
    ' 単位制約、上限制約をチェック
    ' 移動不可能ならエラー表示
End Sub
```

#### 機能B: 品番日程移動
```
Sub 日程ずらし_品番(成形品番 As String, 移動元日 As Long, 移動先日 As Long)
    ' 単一品番を移動
End Sub
```

#### 機能C: 日程交換
```
Sub 日程交換(品番1 As String, 品番2 As String)
    ' 2つの品番の割り当て日を交換
End Sub
```

**UI設計**:
- シート「品番」に調整用セル配置
  - グループID入力セル
  - 移動元日入力セル
  - 移動先日入力セル
  - 実行ボタン

---

## 実装優先順位

1. **最優先**: 課題4（休日反映不具合）
2. **高**: 課題1（型番上限管理）
3. **中**: 課題2（週単位分散）
4. **低**: 課題3（手動微調整）

---

## 次回セッションでの対応方針

### Step 1: 課題4修正（休日反映）
1. 日次割り当てループを稼働日配列ベースに修正
2. デバッグ出力で稼働日チェック
3. テスト実行

### Step 2: 課題1対応（型番上限）
1. ユーザーに型番上限テーブル設計を確認
2. テーブル「_型番上限」作成
3. 日次割り当てロジックに型番上限チェック追加
4. テスト実行

### Step 3: 課題2検討（週単位分散）
1. 納期情報の取得可否を確認
2. 分散ロジックの詳細仕様をユーザーと詰める
3. 実装・テスト

### Step 4: 課題3検討（手動微調整）
1. UI設計をユーザーに提案
2. 実装の可否を確認

---

## 備考

- タグ `v0.1-負荷均し-基本動作版` で現在の状態を保存済み
- 復元方法: `git checkout v0.1-負荷均し-基本動作版 -- src/m転記_負荷均し.bas`
