# m転記_負荷均し 改修方針

## 概要

既存の`m転記_負荷均し`（参考マクロ）に以下の制約を追加する。

**追加制約**:
1. 補給品優先配置: モール品補給品→非モール補給品の順で優先配置
2. 系列別処理: モール×アルヴェル系 → ノアヴォク系 → その他の順で均し
3. 号口単品分散: 号口かつ単品は全て異なる日に分散配置
4. 補給品×号口単品同日禁止: 補給品と号口単品は同じ日に配置しない

## 改修箇所

### 1. 品番マスタ読み込み拡張（行110-150付近）

**現在のコード**:
```vba
品番_成形品番列 = GetColumnIndex(tbl品番, "成形品番")
品番_単位列 = GetColumnIndex(tbl品番, "単位")
品番_上限列 = GetColumnIndex(tbl品番, "上限")
品番_優先度列 = GetColumnIndex(tbl品番, "優先度")
品番_グループ列 = GetColumnIndex(tbl品番, "グループ")
品番_型番列 = GetColumnIndex(tbl品番, "型番")
品番_セット列 = GetColumnIndex(tbl品番, "セット")

For r = 1 To UBound(arr品番, 1)
    ' ... 既存の読み込み ...
    info("グループ") = ...
    info("型番") = ...
    info("セット") = ...
    Set 品番マスタ(CStr(成形品番値)) = info
Next r
```

**追加するコード**:
```vba
' 列インデックス追加
品番_号補列 = GetColumnIndex(tbl品番, "号/補")
品番_系列列 = GetColumnIndex(tbl品番, "系列")
品番_仕様列 = GetColumnIndex(tbl品番, "仕様")

' ループ内で読み込み
Dim 号補Val As Variant, 系列Val As Variant, 仕様Val As Variant
号補Val = arr品番(r, 品番_号補列)
info("号/補") = IIf(IsEmpty(号補Val) Or IsNull(号補Val) Or 号補Val = "", "", CStr(号補Val))

系列Val = arr品番(r, 品番_系列列)
info("系列") = IIf(IsEmpty(系列Val) Or IsNull(系列Val) Or 系列Val = "", "", CStr(系列Val))

仕様Val = arr品番(r, 品番_仕様列)
info("仕様") = IIf(IsEmpty(仕様Val) Or IsNull(仕様Val) Or 仕様Val = "", "", CStr(仕様Val))
```

### 2. 事前チェック追加（セットペアマスタ構築後）

**挿入位置**: セットペアマスタ構築完了後（行200付近）

**追加するコード**:
```vba
' ==========================================
' 号口単品数の事前チェック
' ==========================================
Dim 号口単品数 As Long
号口単品数 = 0

For Each key In 品番マスタ.Keys
    If 品番マスタ(key)("号/補") = "号口" And _
       品番マスタ(key)("セット") <> "SET" Then
        号口単品数 = 号口単品数 + 1
    End If
Next key

Debug.Print "号口単品数: " & 号口単品数

If 号口単品数 > workDays.Count Then
    MsgBox "警告: 号口単品(" & 号口単品数 & "件)が稼働日数(" & workDays.Count & "日)を超えています。" & vbCrLf & _
           "全ての号口単品を異なる日に配置できない可能性があります。", vbExclamation
    ' 続行するか確認
    Dim 確認 As Long
    確認 = MsgBox("それでも続行しますか？", vbYesNo + vbQuestion)
    If 確認 = vbNo Then
        Application.StatusBar = False
        Exit Sub
    End If
End If
```

### 3. 補給品優先配置フェーズ追加（割り当てループの前）

**挿入位置**: 日次割り当てループ（優先度ループ）の直前（行210付近）

**追加するコード**:
```vba
' ==========================================
' フェーズ1: 補給品優先配置
' ==========================================
Debug.Print "=== 補給品優先配置フェーズ ==="

' 1. モール品補給品を品番ごとの最初の納期に配置
Application.StatusBar = "モール品補給品を配置中..."
Call 補給品優先配置_モール( _
    品番マスタ, 月間残数, 転記データ, 当日割り当て, _
    当日型番割り当て, arr展開, 成形品番列, 開始列, _
    maxDay, 日次目標, 誤差許容率, workDays)

' 2. 非モール補給品をグループごとに配置
Application.StatusBar = "非モール補給品を配置中..."
Call 補給品優先配置_通常( _
    品番マスタ, 月間残数, 転記データ, 当日割り当て, _
    当日型番割り当て, グループ初回日, workDays, _
    日次目標, 誤差許容率)

Debug.Print "=== 補給品優先配置完了 ==="
```

### 4. 優先度ループを系列別ループに変更

**現在のコード（行220-300付近）**:
```vba
For 優先度 = 1 To 3
    Debug.Print "--- 優先度" & 優先度 & " 処理開始 ---"

    ' 非セット品番の処理
    For Each key In 品番マスタ.Keys
        If 品番マスタ(key)("優先度") <> 優先度 Then GoTo NextItem1
        ' ... 処理 ...
    Next key

    ' セット品番の処理
    For Each key In セットペアマスタ.Keys
        ' ... 処理 ...
    Next key
Next 優先度
```

**変更後**:
```vba
For 優先度 = 1 To 3
    Debug.Print "--- 優先度" & 優先度 & " 処理開始 ---"

    ' 3. モール品かつアルヴェル系のセット品
    Debug.Print "=== モール×アルヴェル系処理 ==="
    Call 系列別均し処理("モール", "アルヴェル系", 優先度, _
        品番マスタ, セットペアマスタ, 月間残数, 転記データ, _
        当日割り当て, 当日型番割り当て, グループ初回日, _
        workDays, 日次目標, 誤差許容率, maxDay, 開始列, arr均し)

    ' 4. ノアヴォク系のセット品
    Debug.Print "=== ノアヴォク系処理 ==="
    Call 系列別均し処理("", "ノアヴォク系", 優先度, _
        品番マスタ, セットペアマスタ, 月間残数, 転記データ, _
        当日割り当て, 当日型番割り当て, グループ初回日, _
        workDays, 日次目標, 誤差許容率, maxDay, 開始列, arr均し)

    ' 5. その他
    Debug.Print "=== その他処理 ==="
    Call 系列別均し処理("", "その他", 優先度, _
        品番マスタ, セットペアマスタ, 月間残数, 転記データ, _
        当日割り当て, 当日型番割り当て, グループ初回日, _
        workDays, 日次目標, 誤差許容率, maxDay, 開始列, arr均し)
Next 優先度
```

### 5. 割り当て可能数を算出 関数に制約追加

**現在の関数（行600付近）**:
```vba
Private Function 割り当て可能数を算出(...) As Long
    ' 既存の制約チェック
    ' ... 型番制約チェック終わり ...

    ' 単位制約（倍数に丸める）
    割り当て候補 = Int(割り当て候補 / 単位) * 単位
    割り当て可能数を算出 = 割り当て候補
End Function
```

**追加するコード（型番制約チェック終わりの後に挿入）**:
```vba
    ' --- 新規制約1: 号口単品の分散配置 ---
    If 品番マスタ(品番)("号/補") = "号口" And _
       品番マスタ(品番)("セット") <> "SET" Then
        ' 当日に既に他の号口単品が配置されているかチェック
        If 当日号口単品配置済み(稼働日, 品番, 転記データ, 品番マスタ) Then
            Debug.Print "制約違反: 号口単品[" & 品番 & "]は" & 稼働日 & "日に他の号口単品あり"
            割り当て可能数を算出 = 0
            Exit Function
        End If
    End If

    ' --- 新規制約2: 補給品と号口単品の同日配置禁止 ---
    Dim 号補 As String
    号補 = CStr(品番マスタ(品番)("号/補"))

    If 号補 = "補給品" Then
        ' 補給品の場合：当日に号口単品があればNG
        If 当日号口単品あり(稼働日, 転記データ, 品番マスタ) Then
            Debug.Print "制約違反: 補給品[" & 品番 & "]は" & 稼働日 & "日に号口単品あり"
            割り当て可能数を算出 = 0
            Exit Function
        End If
    ElseIf 号補 = "号口" And 品番マスタ(品番)("セット") <> "SET" Then
        ' 号口単品の場合：当日に補給品があればNG
        If 当日補給品あり(稼働日, 転記データ, 品番マスタ) Then
            Debug.Print "制約違反: 号口単品[" & 品番 & "]は" & 稼働日 & "日に補給品あり"
            割り当て可能数を算出 = 0
            Exit Function
        End If
    End If
```

## 新規関数の追加（ファイル末尾）

以下の関数を追加する：

1. `補給品優先配置_モール()`
2. `補給品優先配置_通常()`
3. `系列別均し処理()`
4. `当日号口単品配置済み()`
5. `当日補給品あり()`
6. `当日号口単品あり()`
7. `品番の最初の納期を取得()`

これらの関数は別途実装する。

## 残数処理（フェーズ8）の変更

残数処理も系列別に変更する必要があるが、基本的な構造は同じ。

補給品として配置済みの品番は残数処理から除外する（残数=0になっているはず）。

## テスト方針

1. まず品番マスタ読み込み拡張のみ適用してテスト
2. 補給品優先配置を追加してテスト
3. 系列別処理を追加してテスト
4. 制約チェックを追加してテスト

段階的にテストすることで問題箇所を特定しやすくする。

## 完全版の作成方針

参考マクロ`m転記_負荷均し.bas`をベースに、上記の改修を手動で適用する。

改修箇所が多いため、一度に全て実装するのではなく、段階的に機能追加していくことを推奨。
