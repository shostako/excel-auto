# 2025-11 作業ログ

## 2025-11-04 作業概要

### m転記_グラフ_流出詳細.bas の修正と機能追加

#### 問題発見
- 参考マクロフォルダ内の既存マクロで、実行後に関数が数値に変わってしまう問題を発見
- 原因: `DataBodyRange.Value = arr出力` によるテーブル全体の配列一括書き込み
- 配列には関数式ではなく計算結果の値しか保存されないため、書き戻し時に関数が消失

#### 実装した修正
1. **関数消失問題の修正**
   - 配列一括書き込み → 列単位書き込みに変更
   - 更新対象列（流出・廃棄・成形・塗装）のみに個別に書き込み
   - 他の列（関数含む）は一切触らない設計

2. **新規機能追加**
   - 差戻し集計機能の追加:
     - `_手直し`テーブルの「差戻し」列（0/1形式）を判定
     - 差戻し=1: 発生×発見2の組み合わせで差戻し系変数に集計
     - 差戻し=0または空白: 加工手直し系変数に集計

   - 新規転記先の追加:
     - 「廃棄」行 → 成形列・塗装列に廃棄数を転記
     - 「差戻し」行 → 成形列・塗装列に差戻し数を転記
     - 「加工手直し」行 → 成形列・塗装列に加工手直し数を転記

#### 技術的なポイント
- **列単位書き込みパターン**:
  ```vba
  lo出力.ListColumns("流出").DataBodyRange.Value = arr流出
  lo出力.ListColumns("廃棄").DataBodyRange.Value = arr廃棄
  lo出力.ListColumns("成形").DataBodyRange.Value = arr成形
  lo出力.ListColumns("塗装").DataBodyRange.Value = arr塗装
  ```
- 各列用の1次元配列を個別に作成
- Select Case構文で工程名に応じた値を振り分け
- 既存の流出・廃棄集計ロジックも維持

#### トラブルシューティング
- 初回実行時に「インデックスが有効範囲にありません」エラー発生
- 原因: パワークエリで「差戻し」列を`_手直し`テーブルに引っ張っていなかった
- ユーザーがパワークエリを修正後、正常動作を確認

#### 教訓
- **配列の一括読み書きの落とし穴**:
  - `.Value`プロパティは関数式ではなく計算結果しか返さない
  - テーブル全体を配列で上書きすると、関数が値に変換される
  - 更新が必要な列だけに書き込むのが安全

- **エンコーディング管理の重要性**:
  - 参考マクロ（Shift-JIS）を読む前に必ずiconv変換
  - 文字化けしたまま読むと列名を誤認識する重大事故につながる

- **テーブル構造の事前確認**:
  - パワークエリでデータソースが正しく設定されているか確認
  - 列の存在確認を怠るとランタイムエラーになる

#### 成果物
- `src/m転記_グラフ_流出詳細.bas` (UTF-8版)
- `macros/m転記_グラフ_流出詳細.bas` (Shift-JIS版・Excel取り込み用)

---

## 2025-11-06 作業概要

### Web版Claude Code対応とGitHub連携の再構築

#### 背景
- Claude CodeのWeb版がリリースされ、GitHubリポジトリと連携可能に
- ローカル開発環境ではGitHub連携を停止していたが、Web版で使用するため再接続が必要
- 親ディレクトリ（`/home/shostako/ClaudeCode/`）のCLAUDE.mdはGit管理外のため、Web版から参照不可

#### 実施内容

1. **CLAUDE.mdの統合**
   - 親ディレクトリの共通設定（Monday設定、作業ログルール等）をプロジェクト内CLAUDE.mdに統合
   - 構成:
     - 共通設定（Monday設定）セクション
     - プロジェクト固有設定（Excel開発）セクション
   - これによりWeb版でもMonday設定が有効化

2. **SSH認証のセットアップ**
   - 既存のHTTPS認証（Personal Access Token）が期限切れ
   - Ed25519形式のSSHキーペアを新規生成
   - 手順:
     ```bash
     ssh-keygen -t ed25519 -C "shostako@github" -f ~/.ssh/id_ed25519 -N ""
     eval "$(ssh-agent -s)" && ssh-add ~/.ssh/id_ed25519
     ```
   - 公開鍵をGitHubに登録（Title: `WSL_excel-auto`）
   - SSH接続テスト成功: `ssh -T git@github.com`

3. **リモートURL変更とプッシュ**
   - HTTPS形式からSSH形式に変更:
     ```bash
     git remote set-url origin git@github.com:shostako/excel-auto.git
     ```
   - ローカルが62コミット先行、リモートが2コミット先行（コンフリクト）
   - `git push --force-with-lease` でローカルを正として強制上書き
   - 62コミット分（直近の開発履歴）をGitHubに反映

#### 技術的なポイント

- **SSH vs HTTPS認証**:
  - SSH: 一度設定すれば永続的、トークン期限切れの心配なし
  - HTTPS: 簡単だが、トークン期限管理が必要
  - Ed25519形式: RSAより新しく安全、鍵長も短い

- **force-with-leaseの使用**:
  - 通常の`--force`より安全
  - リモートが予期せず更新されている場合は失敗する
  - 今回はローカルが正しい状態と判断して使用

- **ローカルとWeb版の使い分け**:
  - 実体はGitHub上のリポジトリ
  - ローカル（CLI版）とWeb版の両方からアクセス可能
  - 同時編集はコンフリクトの原因になるため、基本的にどちらかメインで使用

#### 成果物
- `CLAUDE.md`: Monday設定を含む統合版に更新
- SSH認証設定: `~/.ssh/id_ed25519`（秘密鍵）、`~/.ssh/id_ed25519.pub`（公開鍵）
- GitHubリポジトリ: 最新の62コミット分を反映

#### 教訓
- **設定ファイルの配置**:
  - Git管理外のディレクトリに設定を置くと、リモート参照時に読めない
  - 共通設定は各プロジェクトのCLAUDE.mdに統合する方が確実

- **認証方式の選択**:
  - 長期運用ではSSH認証が推奨
  - トークン管理の手間がなく、セキュリティも高い

- **force pushの判断**:
  - リモートの変更内容を確認してから判断
  - 今回はGitHub Actions時代の残骸（削除コミット）のため上書きOK
  - 通常は`git pull --rebase`で統合する方が安全
