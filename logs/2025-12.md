# 2025年12月 作業ログ

## 2025-12-01 作業概要

### 不良数集計バグ修正（m転記_流出_成形G.bas）

**問題**：
- 58050RrLH列で不良数=20だが、項目別合計=19（1件不足）
- ユーザー調査で廃棄テーブルの不良内容列に空白セルがあることを発見

**原因特定**：
- 手直し/廃棄テーブル処理で `If Len(mode2) > 0 Then` / `If Len(furyouNaiyou) > 0 Then` の条件があった
- 不良数は無条件で加算されるが、項目別は空欄だとスキップされる
- 結果：空欄のレコードがあると不良数と項目別合計が不一致

**修正**：
- 空欄の場合は「（空白）」という項目名で集計するように変更
- 手直し処理（行422-427）と廃棄処理（行477-482）の2箇所を修正

**教訓**：
- 集計処理では「加算条件」と「分類条件」が一致しているか確認すること
- 空欄データの扱いを明示的に定義しておくことが重要

---

## 2025-12-05 作業概要

### 空欄処理バグ修正の横展開（5ファイル）

12/1に成形Gで修正した空欄処理を、他の5ファイルにも適用。

**対象ファイル**:
| ファイル | 修正箇所 |
|----------|----------|
| m転記_流出_塗装G.bas | 手直し(hdMode2) + 廃棄(hkFuryou) |
| m転記_流出_加工G.bas | 手直し(hdMode2) + 廃棄(hkFuryou) |
| m転記_廃棄_成形H.bas | 廃棄(furyouNaiyou) |
| m転記_廃棄_塗装H.bas | 廃棄(furyou) |
| m転記_廃棄_加工H.bas | 廃棄(furyou) |

**修正内容**:
```vba
' Before: 空欄をスキップ
If Len(xxx) > 0 Then
    If Not aggItems(...).Exists(xxx) Then
        aggItems(...)(xxx) = 0
    End If
    aggItems(...)(xxx) = aggItems(...)(xxx) + count
End If

' After: 空欄を「（空白）」として集計
If Len(xxx) = 0 Then xxx = "（空白）"
If Not aggItems(...).Exists(xxx) Then
    aggItems(...)(xxx) = 0
End If
aggItems(...)(xxx) = aggItems(...)(xxx) + count
```

### G系列タイトル表記変更（3ファイル）

**変更内容**:
- Before: `流出G_成形_期間1_12/1~12/5`
- After: `成形_流出手直し（廃棄込）12/1~12/5`

**対象**: 成形G、塗装G、加工G

### 構文エラー修正

**問題**: 初回コミット後、Excelでコンパイルエラー発生
- エラー: 「End If に対応する If ブロックがありません」

**原因**:
- 元の `If Len(xxx) > 0 Then` を削除した際、対応する `End If` を削除し忘れた
- 結果として孤立した `End If` が残り、構文エラーに

**教訓**:
- `If...End If` ブロックを修正する際は、必ずペアで確認すること
- 特に条件分岐を削除する場合、対応する `End If` の処理を忘れやすい

---

## 2025-12-09 作業概要

### フィルターマクロ大幅改善

成形進捗表用のフィルターマクロを新規開発・改善。

**新規作成マクロ**:
| マクロ | 参照セル | 対象テーブル |
|--------|---------|-------------|
| 側板フィルター | C3 | _完成品のみ |
| 項目フィルター | E3 | 全テーブル |

**排他的フィルター方式の実装**:
- 完成品/側板/小部品フィルターは排他的（1つ実行すると他のB3,C3,D3をクリア）
- 項目フィルター(E3)は独立（他のフィルターと組み合わせ可能）
- フィルター解除時: B3,C3,D3=空白、E3=「全項目」

**項目フィルター仕様**:
| E3の値 | 動作 |
|--------|------|
| 全項目 | フィルターなし（実質フィルター解除） |
| カンマ区切り | 各要素に完全一致（OR条件） |
| 単一値 | 完全一致 |

例：
- `実績,在庫実績` → 「実績」または「在庫実績」に一致する行を表示
- `実績,計画` → 「実績」または「計画」に一致する行を表示

### 複数シート対応

**問題**: シートをコピーするとテーブル名が自動変更される（`_完成品` → `_完成品2`）

**解決策**: テーブル名のパターン検索
```vba
' mCommon.bas
Public Function FindTableByPattern(ws As Worksheet, pattern As String) As ListObject
    Dim tbl As ListObject
    For Each tbl In ws.ListObjects
        If InStr(tbl.Name, pattern) > 0 Then
            Set FindTableByPattern = tbl
            Exit Function
        End If
    Next tbl
End Function
```

**イベント処理**:
- `Worksheet_Change`（シート固有）→ `Workbook_SheetChange`（ブック全体）に変更
- ThisWorkbookモジュールに配置することで、全シートで自動フィルター実行

**教訓**:
- テーブル名のハードコードは複数シート対応で問題になる
- パターン検索方式なら、同一シートに同じパターンのテーブルが2つ以上なければ動作する
- Workbook_SheetChangeは全シートで発火するため、複数シート対応に有効

### PROGRESS.md手動更新ルール展開

**発端**: PROGRESS.mdの時刻更新時に`date`コマンドで確認せず15:30を入力→実際は11:57だった

**対応**: 全プロジェクト（11件）のCLAUDE.mdに以下ルールを追加
```markdown
## PROGRESS.md手動更新時の注意
- **時刻更新時は必ず`date '+%Y-%m-%d %H:%M'`で現在時刻を確認してから記入**
- 推測や概算で時刻を入れない
```

**詳細**: 親ログ参照（`/home/shostako/ClaudeCode/logs/2025-12.md`）

### 日付表示マクロ新規作成

**目的**: A3の日付を参照して、その日付列が画面左端に来るようスクロール

**仕様**:
- 参照セル: A3（日付）
- 日付行: 6行目（G列から12/1, 12/2, ...と並ぶ）
- ウィンドウ枠固定: G7
- 動作: A3の日付を6行目から検索 → その列にスクロール
- 日付未発見時: G7（先頭）に戻る

**ThisWorkbook対応**: A3変更時に自動で日付表示マクロを呼び出し

### フィルターマクロの水平スクロール維持

**問題**: フィルターマクロ実行時に`Application.Goto`で画面左上にスクロールしていた

**解決策**: `ActiveWindow.ScrollRow = 1`で垂直のみスクロール（水平位置維持）

### 複合フィルター対応

**問題**: 項目フィルター（E3）を設定した状態で完成品等を実行すると、項目フィルター結果がリセットされる

**解決策**: 完成品・側板・小部品フィルターで、自身の条件 **AND** 項目条件の両方を適用

**共通関数追加**（mCommon.bas）:
- `GetItemFilterMode`: E3の値からフィルターモードを判定
- `MatchItemFilter`: 項目フィルター条件に一致するか判定（カンマ区切り対応）

---

## 2025-12-10 作業概要

### イベントコード方式変更（Workbook_SheetChange → Worksheet_Change分配）

**問題発覚**:
- Workbook_SheetChangeは**ブック内の全シート**でセル変更時に発火する
- フィルター機能対象外の異なる書式のシートがある場合、同じセル番号変更でマクロ実行を試みてエラー

**解決策**:
- ThisWorkbookの`Workbook_SheetChange`を廃止
- フィルター機能を使う各シートに`Worksheet_Change`を個別配置（Sheet1.cls）

**教訓**:
- Workbook_SheetChangeは「ブック全体が同一書式のシート」でのみ有効
- 異なる書式のシートが混在するブックでは、Worksheet_Changeを対象シートに分配する方式が安全
- シートごとのイベントコードは`.cls`ファイルで管理

---

## 2025-12-11 作業概要

### 項目フィルター「合計」行常時表示機能追加

**要件**:
- 項目列フィルター適用時、「合計」行はフィルター条件に関わらず常に表示
- 「合計」行が存在しない場合もエラーにならないこと

**実装**:
```vba
' セクション5: 項目フィルター適用
cellValue = dataArr(i, 1)
' 「合計」行は常に表示
If cellValue = "合計" Then
    ' 何もしない（常に表示）
ElseIf Not MatchItemFilter(cellValue, filterMode, filterItem) Then
    ws.Rows(rowNum).Hidden = True
End If
```

**判定方式**: 完全一致（「小計」「合計欄」等は対象外）
