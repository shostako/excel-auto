# 2025年12月 作業ログ

## 2025-12-01 作業概要

### 不良数集計バグ修正（m転記_流出_成形G.bas）

**問題**：
- 58050RrLH列で不良数=20だが、項目別合計=19（1件不足）
- ユーザー調査で廃棄テーブルの不良内容列に空白セルがあることを発見

**原因特定**：
- 手直し/廃棄テーブル処理で `If Len(mode2) > 0 Then` / `If Len(furyouNaiyou) > 0 Then` の条件があった
- 不良数は無条件で加算されるが、項目別は空欄だとスキップされる
- 結果：空欄のレコードがあると不良数と項目別合計が不一致

**修正**：
- 空欄の場合は「（空白）」という項目名で集計するように変更
- 手直し処理（行422-427）と廃棄処理（行477-482）の2箇所を修正

**教訓**：
- 集計処理では「加算条件」と「分類条件」が一致しているか確認すること
- 空欄データの扱いを明示的に定義しておくことが重要

---

## 2025-12-05 作業概要

### 空欄処理バグ修正の横展開（5ファイル）

12/1に成形Gで修正した空欄処理を、他の5ファイルにも適用。

**対象ファイル**:
| ファイル | 修正箇所 |
|----------|----------|
| m転記_流出_塗装G.bas | 手直し(hdMode2) + 廃棄(hkFuryou) |
| m転記_流出_加工G.bas | 手直し(hdMode2) + 廃棄(hkFuryou) |
| m転記_廃棄_成形H.bas | 廃棄(furyouNaiyou) |
| m転記_廃棄_塗装H.bas | 廃棄(furyou) |
| m転記_廃棄_加工H.bas | 廃棄(furyou) |

**修正内容**:
```vba
' Before: 空欄をスキップ
If Len(xxx) > 0 Then
    If Not aggItems(...).Exists(xxx) Then
        aggItems(...)(xxx) = 0
    End If
    aggItems(...)(xxx) = aggItems(...)(xxx) + count
End If

' After: 空欄を「（空白）」として集計
If Len(xxx) = 0 Then xxx = "（空白）"
If Not aggItems(...).Exists(xxx) Then
    aggItems(...)(xxx) = 0
End If
aggItems(...)(xxx) = aggItems(...)(xxx) + count
```

### G系列タイトル表記変更（3ファイル）

**変更内容**:
- Before: `流出G_成形_期間1_12/1~12/5`
- After: `成形_流出手直し（廃棄込）12/1~12/5`

**対象**: 成形G、塗装G、加工G

### 構文エラー修正

**問題**: 初回コミット後、Excelでコンパイルエラー発生
- エラー: 「End If に対応する If ブロックがありません」

**原因**:
- 元の `If Len(xxx) > 0 Then` を削除した際、対応する `End If` を削除し忘れた
- 結果として孤立した `End If` が残り、構文エラーに

**教訓**:
- `If...End If` ブロックを修正する際は、必ずペアで確認すること
- 特に条件分岐を削除する場合、対応する `End If` の処理を忘れやすい

---

## 2025-12-09 作業概要

### フィルターマクロ大幅改善

成形進捗表用のフィルターマクロを新規開発・改善。

**新規作成マクロ**:
| マクロ | 参照セル | 対象テーブル |
|--------|---------|-------------|
| 側板フィルター | C3 | _完成品のみ |
| 項目フィルター | E3 | 全テーブル |

**排他的フィルター方式の実装**:
- 完成品/側板/小部品フィルターは排他的（1つ実行すると他のB3,C3,D3をクリア）
- 項目フィルター(E3)は独立（他のフィルターと組み合わせ可能）
- フィルター解除時: B3,C3,D3=空白、E3=「全項目」

**項目フィルター仕様**:
| E3の値 | 動作 |
|--------|------|
| 全項目 | フィルターなし（実質フィルター解除） |
| カンマ区切り | 各要素に完全一致（OR条件） |
| 単一値 | 完全一致 |

例：
- `実績,在庫実績` → 「実績」または「在庫実績」に一致する行を表示
- `実績,計画` → 「実績」または「計画」に一致する行を表示

### 複数シート対応

**問題**: シートをコピーするとテーブル名が自動変更される（`_完成品` → `_完成品2`）

**解決策**: テーブル名のパターン検索
```vba
' mCommon.bas
Public Function FindTableByPattern(ws As Worksheet, pattern As String) As ListObject
    Dim tbl As ListObject
    For Each tbl In ws.ListObjects
        If InStr(tbl.Name, pattern) > 0 Then
            Set FindTableByPattern = tbl
            Exit Function
        End If
    Next tbl
End Function
```

**イベント処理**:
- `Worksheet_Change`（シート固有）→ `Workbook_SheetChange`（ブック全体）に変更
- ThisWorkbookモジュールに配置することで、全シートで自動フィルター実行

**教訓**:
- テーブル名のハードコードは複数シート対応で問題になる
- パターン検索方式なら、同一シートに同じパターンのテーブルが2つ以上なければ動作する
- Workbook_SheetChangeは全シートで発火するため、複数シート対応に有効

### PROGRESS.md手動更新ルール展開

**発端**: PROGRESS.mdの時刻更新時に`date`コマンドで確認せず15:30を入力→実際は11:57だった

**対応**: 全プロジェクト（11件）のCLAUDE.mdに以下ルールを追加
```markdown
## PROGRESS.md手動更新時の注意
- **時刻更新時は必ず`date '+%Y-%m-%d %H:%M'`で現在時刻を確認してから記入**
- 推測や概算で時刻を入れない
```

**詳細**: 親ログ参照（`/home/shostako/ClaudeCode/logs/2025-12.md`）

### 日付表示マクロ新規作成

**目的**: A3の日付を参照して、その日付列が画面左端に来るようスクロール

**仕様**:
- 参照セル: A3（日付）
- 日付行: 6行目（G列から12/1, 12/2, ...と並ぶ）
- ウィンドウ枠固定: G7
- 動作: A3の日付を6行目から検索 → その列にスクロール
- 日付未発見時: G7（先頭）に戻る

**ThisWorkbook対応**: A3変更時に自動で日付表示マクロを呼び出し

### フィルターマクロの水平スクロール維持

**問題**: フィルターマクロ実行時に`Application.Goto`で画面左上にスクロールしていた

**解決策**: `ActiveWindow.ScrollRow = 1`で垂直のみスクロール（水平位置維持）

### 複合フィルター対応

**問題**: 項目フィルター（E3）を設定した状態で完成品等を実行すると、項目フィルター結果がリセットされる

**解決策**: 完成品・側板・小部品フィルターで、自身の条件 **AND** 項目条件の両方を適用

**共通関数追加**（mCommon.bas）:
- `GetItemFilterMode`: E3の値からフィルターモードを判定
- `MatchItemFilter`: 項目フィルター条件に一致するか判定（カンマ区切り対応）

---

## 2025-12-10 作業概要

### イベントコード方式変更（Workbook_SheetChange → Worksheet_Change分配）

**問題発覚**:
- Workbook_SheetChangeは**ブック内の全シート**でセル変更時に発火する
- フィルター機能対象外の異なる書式のシートがある場合、同じセル番号変更でマクロ実行を試みてエラー

**解決策**:
- ThisWorkbookの`Workbook_SheetChange`を廃止
- フィルター機能を使う各シートに`Worksheet_Change`を個別配置（Sheet1.cls）

**教訓**:
- Workbook_SheetChangeは「ブック全体が同一書式のシート」でのみ有効
- 異なる書式のシートが混在するブックでは、Worksheet_Changeを対象シートに分配する方式が安全
- シートごとのイベントコードは`.cls`ファイルで管理

---

## 2025-12-11 作業概要

### 項目フィルター「合計」行常時表示機能追加

**要件**:
- 項目列フィルター適用時、「合計」行はフィルター条件に関わらず常に表示
- 「合計」行が存在しない場合もエラーにならないこと

**実装**:
```vba
' セクション5: 項目フィルター適用
cellValue = dataArr(i, 1)
' 「合計」行は常に表示
If cellValue = "合計" Then
    ' 何もしない（常に表示）
ElseIf Not MatchItemFilter(cellValue, filterMode, filterItem) Then
    ws.Rows(rowNum).Hidden = True
End If
```

**判定方式**: 完全一致（「小計」「合計欄」等は対象外）

### /wrapコマンド新規作成

**目的**: セッション終了時の定型作業を一括実行

**設置場所**: `/home/shostako/ClaudeCode/.claude/commands/wrap.md`（全プロジェクト共通）

**実行内容**:
1. 未コミットの変更をコミット
2. PROGRESS.md更新（時刻、完了タスク、直近コミット）
3. logs/yyyy-MM.mdに作業ログ追記
4. git push
5. inboxフォルダがあればクリーンアップ確認

**Mondayの行動ルール追加**:
- タスク完了後「wrapするか？」と確認
- CLAUDE.mdに記載

### .claude/rules/ディレクトリ導入

**背景**:
- Claude Code v2.0.64で`.claude/rules/`機能が追加
- CLAUDE.md（424行）が肥大化、メンテナンス性に課題

**実施内容**:
- CLAUDE.mdを8個のルールファイルに分割
- CLAUDE.md: 424行 → 33行（最小構成）

**作成ファイル**:
| ファイル | 行数 | 内容 |
|---------|-----|------|
| 01-session-workflow.md | 19 | セッション開始/終了ルール |
| 02-monday-behavior.md | 15 | Mondayの行動ルール |
| 03-logging.md | 17 | 作業ログルール |
| 04-subagent-planmode.md | 81 | サブエージェント・Plan Mode運用 |
| 10-vba-required-reading.md | 31 | 必読ファイル |
| 11-vba-coding-standards.md | 129 | VBAコーディング規約 |
| 12-vba-encoding.md | 84 | 文字エンコーディング管理 |
| 13-git-workflow.md | 71 | Git/Makefileフロー |

**番号体系**:
- 01-09: 共通ルール（後で親プロジェクトに移動予定）
- 10-19: プロジェクト固有ルール（VBA開発）

**.gitignore修正**:
- `.claude/`全体除外 → `rules/`, `commands/`, `skills/`はgit管理に含める

**削除したセクション**:
- トークン確認コマンド（不要になったため）

**次回（Phase 2）**:
- 親プロジェクトに共通ルール展開
- シンボリックリンクで子プロジェクトから参照

---

## 2025-12-15 作業概要

### フィルターマクロ「稼働日」行常時表示機能追加

**要件**:
- どのフィルター（完成品/側板/小部品/項目）を適用しても、「項目」列が「稼働日」の行は常に表示

**対象ファイル**:
| ファイル | 変更内容 |
|---------|---------|
| m項目フィルター.bas | 「合計」の条件に「稼働日」を追加 |
| m完成品フィルター.bas | 2箇所で「稼働日」行スキップ処理追加 |
| m小部品フィルター.bas | 全テーブル処理で「稼働日」行スキップ |
| m側板フィルター.bas | 2箇所で「稼働日」行スキップ処理追加 |

**実装パターン**:
```vba
' 項目フィルター: 既存の「合計」条件を拡張
If cellValue = "合計" Or cellValue = "稼働日" Then
    ' 何もしない（常に表示）

' 他のフィルター: 非表示処理前に判定
If itemArr(i, 1) <> "稼働日" Then
    If 条件 Then
        ws.Rows(...).Hidden = True
    End If
End If
```

**判定方式**: 完全一致

### 項目追加・削除マクロ新規作成（汎用化）

**項目追加マクロ**:
```vba
Sub 項目追加(tableName As String, targetItem As String, newItem As String)
' 例: Call 項目追加("_完成品", "在庫実績", "在庫目標")
```
- テーブル名、検索する項目、追加する項目を引数で指定
- 指定した項目行の下に新しい行を追加
- 製品名/側板/小部品は上の行からコピー、日付列は左隣参照の関数設定

**項目削除マクロ**:
```vba
Sub 項目削除(tableName As String, targetItem As String)
' 例: Call 項目削除("_完成品", "在庫目標")
```
- テーブル名、削除する項目を引数で指定
- 該当する全ての行を削除

**共通仕様**:
- FindTableByPatternでパターン検索（シートコピー対応）
- フィルターがかかっている場合は自動解除
- 下から上へ処理（インデックスずれ防止）
- 冪等性対応

**バグ修正**:
- AutoFilterがないテーブルでエラー91が発生する問題を修正
- `If Not tbl.AutoFilter Is Nothing Then` でチェック追加

---

## 2025-12-16 作業概要

### フィルター解除マクロ改修

**問題**:
- 手動でオートフィルターを設定した後、フィルター解除マクロを実行
- 行は全部表示されるが、フィルターボタンのチェック状態が残ったまま

**原因**:
- `Row.Hidden = False`（行の非表示解除）と`AutoFilter`は別機能
- 既存マクロは行の非表示解除のみで、オートフィルターに触れていなかった

**修正内容**:
```vba
' 行の非表示を解除
If Not tbl.DataBodyRange Is Nothing Then
    tbl.DataBodyRange.EntireRow.Hidden = False
End If

' オートフィルターもリセット（フィルター適用中の場合のみ）
If tbl.AutoFilter.FilterMode Then
    tbl.AutoFilter.ShowAllData
End If
```

**追加改善**:
- テーブルが見つからない場合のNothingチェック追加（スキップ）
- DataBodyRangeがNothingの場合のチェック追加（ヘッダーのみテーブル対応）

**設計確認**:
- テーブル名検索：部分一致（InStr）→ シートコピー時の「_完成品2」等に対応するため意図的
- 検索範囲：アクティブシートのみ → 同じマクロを複数シートで流用するため意図的

### wrap時クリーンアップルール明確化

**背景**: wrapする際にsrcの削除ファイルについて「これは前回の整理か？」とぶつぶつ言って確認を求めていた

**問題**:
- inbox/macrosはユーザーとの受け渡しフォルダなのでクリア確認は不要
- srcはClaudeが管理するマスターなのでユーザー確認は不要

**ルール更新**（13-git-workflow.md）:
| フォルダ | wrap時の処理 |
|---------|-------------|
| inbox/ | 自動クリア（確認なし） |
| macros/ | 自動クリア（確認なし） |
| src/ | 変更があればそのままコミット（確認なし） |
