# 2026年1月 作業ログ

## 2026-01-21 作業概要

### UserForm5 完成（微調整・機能追加）

**入力制限の追加**:
- CTextBoxEventクラスハンドラを動的生成TextBoxに接続
- 配列で管理（dateHandlers, lotHandlers, zoneHandlers, numberHandlers, quantityHandlers, returnHandlers）
- Initialize時にReDim、CreateRecordRow時に接続、ClearDynamicControls時に解放

**フォント設定**:
- 動的コントロール: Meiryo UI, サイズ9
- コマンドボタン・トグル: Yu Gothic UI, サイズ12, 太字

**ID欄の窪み対応**:
- LabelからTextBoxに変更
- `SpecialEffect = fmSpecialEffectSunken`
- `Locked = True`, `TabStop = False`
- `BackColor = &H8000000F`（システムボタンフェイス色）

**選択列の削除**:
- ユーザー判断：「修正は何も変更しなければ同値上書き、削除は最初からIDを絞れば済む」
- COL_CHK定数、CheckBox生成・削除処理、選択カウント処理を全削除
- 各行のコントロール数: 9 → 8

**TabIndex設定**:
- 西暦(0)→トグル(1)→ID指定(2)→検索(3)→動的行（各行8コントロール）→実行→閉じる
- 検索後は1行目の日付にフォーカス

**誤操作防止**:
- 検索後：トグル・ID欄・検索ボタンを無効化（Enabled = False）
- 実行後・エラー後：再有効化

**レイアウト微調整**:
- BUTTON_MARGIN: 40 → 15（ボタン余白縮小）
- DATA_START_TOP: 124 → 114（ヘッダー・データ行間の余白縮小）
- LABEL_INDENT: 4追加（ヘッダーラベルを半角分右へ）

**最終的な列位置定数**:
```vba
Private Const COL_ID As Integer = 12
Private Const COL_DATE As Integer = 60
Private Const COL_ITEM As Integer = 134
Private Const COL_LOT As Integer = 213
Private Const COL_FIND As Integer = 253
Private Const COL_ZONE As Integer = 293
Private Const COL_NUM As Integer = 333
Private Const COL_QTY As Integer = 373
Private Const COL_RET As Integer = 413
```

**教訓**:
- 動的生成TextBoxにもCTextBoxEventクラスハンドラを接続できる（配列で管理）
- 選択列は不要な場合が多い（処理対象をIDで絞る方がシンプル）

### UserForm5 追加機能

**ID範囲指定対応**:
- `22-25` → 22,23,24,25 に展開
- カンマ区切りと範囲指定の混在可能（例: `22-25,30,32-34`）
- ParseIDInput関数を追加

**DataModifiedフラグ追加**:
- `Public DataModified As Boolean`
- 修正または削除が実行されたらTrue
- 呼び出し元でクエリ更新の判定に使用

**削除モード対応**:
- 検索後：データコントロールを無効化（Enabled = False）
- 検索後：実行ボタンにフォーカス
- 削除実行後：フォームを自動で閉じる（Unload Me）

### 転送マクロ改修

**mゾーン別データ転送ADO.bas**:
- targetFieldsから「品番末尾」「注番月」を削除
- 理由：入力フォームからこれらのフィールドを削除済み

### クエリ西暦更新マクロ新規作成

**mクエリ西暦更新.bas**:
- シート「不良集計ゾーン別ADO」G2から年を取得
- Power Queryの接続先DBを動的変更
- クエリをリフレッシュ

**不良集計ゾーン別ADO.pq**:
- 年間DB（不良調査表DB-{年}.accdb）のみ参照
- 月別DB結合処理を削除

### 自動採番リセットマクロ改修

**m自動採番リセットAccess.bas**:
- DBパスを動的構築に変更（他マクロと統一）
- InputBoxで年を入力
- Dir()でファイル存在チェック追加

---

## 2026-01-20 作業概要

### 品番末尾・注番月フィールド削除

**背景**: 不良集計入力フォームの簡素化

**変更ファイル**:
- `src/UserForm2.frm` - ComboBox3（品番末尾）、TextBox2（注番月）を削除
- `src/CTextBoxEvent.cls` - Monthタグ処理を削除
- `src/mゾーン別データ転送ADO.bas` - targetFieldsから品番末尾・注番月を削除

**注意点**: Access側の列は残っても問題なし（INSERTで指定しないフィールドはNULLになるだけ）

---

### UserForm5（データ修正・削除フォーム）新規作成

**背景**:
- 入力者を別の人に譲渡予定
- Access本体を直接触らせたくない（操作ミス・破損リスク）
- パワークエリで読み込んだ際にID列が見えるため、IDベースでの特定が可能

**設計**:
- 同一フォームで修正・削除（トグルボタンで切替）
- 年は現在西暦をデフォルト、変更可能
- ID入力はカンマ区切り（最大10件）
- 検索後に動的コントロール生成（ヘッダーラベルも動的）
- トランザクション制御（エラー時ロールバック）

**静的コントロール**:
- ComboBoxYear（西暦選択）
- ToggleButtonMode（修正/削除切替）
- TextBoxIDs（ID入力）
- CommandButtonSearch, CommandButtonExecute, CommandButtonClose

**動的コントロール**:
- ヘッダーラベル10個（ID, 日付, 品番, ロット, 発見, ゾーン, 番号, 数量, 差戻, 選択）
- データ行（最大10行 × 10コントロール）

**列位置定数**:
```vba
Private Const COL_ID As Integer = 12
Private Const COL_DATE As Integer = 60
Private Const COL_ITEM As Integer = 134
Private Const COL_LOT As Integer = 213
Private Const COL_FIND As Integer = 253
Private Const COL_ZONE As Integer = 293
Private Const COL_NUM As Integer = 333
Private Const COL_QTY As Integer = 373
Private Const COL_RET As Integer = 413
Private Const COL_CHK As Integer = 450
```

**教訓**:
- ヘッダーラベルを静的配置すると動的生成コントロールと位置がズレる
- 解決策: ヘッダーラベルも動的生成にして列位置定数を共有

---

## 2026-01-12 作業概要

### Windows環境のexcel-autoプロジェクト問題分析

**発端**:
- Windows環境（WezTerm + PowerShell）でexcel-autoプロジェクトを運用
- ファイル読み込み/書き込みでエラーが頻発
- 日本語ファイル名の文字化け

**根本原因特定**:
- Claude CodeのBashツールはGit Bash（`/usr/bin/bash`）を使用
- ナレッジにはPowerShellコマンド（`Get-Content -Encoding oem`）を記載
- bash → pwsh の二重シェル層で日本語パスが文字化け

**調査結果**:
- Claude Codeに`defaultShell`設定は存在しない
- Unix系シェル（bash）前提の設計思想
- PowerShellネイティブ対応は公式には未サポート
- GitHub Issue #6453で同様の問題が報告済み

**結論**:
- excel-autoプロジェクトはWSL環境に戻す
- WSL2（本物のLinux）の方がClaude Codeとの相性が良い

### Windows版ナレッジのWSL版へのマージ

**マージ対象**（環境非依存の知見）:

1. **11-vba-coding-standards.md** に追加:
   - コメント標準セクション（ヘッダーコメント必須/任意項目）
   - 実例（転記マクロ）
   - 「なぜActivateが禁止なのか（過去の失敗から）」詳細セクション
   - 症状診断フロー
   - 最適化の優先順位（黄金律）

2. **12-vba-encoding.md** に追加:
   - 参照名の確認（推測禁止）セクション

**環境依存部分**:
- パス、変換コマンドはWSL用（iconv、bash）のまま維持
- PowerShellコマンドの混入なし

### /vbaコマンド新規作成

**目的**: VBAマクロ生成ワークフローの標準化

**設置場所**: `~/.claude/commands/vba.md`

**内容**:
1. 処理概要確認
2. 情報十分性判断（A: 生成開始 / B: 追加情報）
3. 追加情報収集（Bの場合）
4. 参考マクロ読み込み（iconv変換）
5. excel-vba-expertスキル呼び出し
6. マクロ生成 + bas2sjis変換

**Windows版との差分**: 環境依存コマンドのみ（iconv、bas2sjis bash版）

### WezTermでWSL環境を使う設定

**背景**:
- WSLのUbuntuターミナルではShift+Enterが非対応
- WezTermはShift+Enterをネイティブサポート
- 以前は「wsl → Enter → cd ~」の手間を嫌ってWindows専用にしていた

**解決策**: Logicool Options+でショートカット設定
- ショートカット1: WezTerm → Windows環境（lab用）
- ショートカット2: WezTerm → WSL環境（excel-auto用）

**メリット**:
- 両環境でShift+Enter対応
- ワンクリックで環境切り替え
- WezTermのdefault設定を弄る必要なし

**補足**: WezTermからWSLに入るとカレントディレクトリが`/mnt/c/Users/shost`になる。WSLホームに移動するには`cd ~`。自動化したい場合はWezTerm設定で`--cd ~`オプションを追加。

---

## 2026-01-12 Claude in Chrome WSLブリッジ設定

### 問題

WSL環境からClaude CodeのChrome MCP（`mcp__claude-in-chrome__*`）を使おうとすると「Browser extension is not connected」エラー。

### 原因

1. Chrome拡張機能はWindows側のNative Messaging Hostを使う
2. WSLとWindowsは別環境なので直接通信できない
3. 拡張機能が使うNative Host名が`com.anthropic.claude_browser_extension`（ブリッジは別名で登録していた）

### 解決策：WSL-Windows ブリッジ

**設定ファイル場所**: `C:\Users\shost\AppData\Roaming\Claude\ChromeNativeHost\`

**1. batファイル（ブリッジ本体）**
```batch
@echo off
wsl.exe -d Ubuntu-22.04 -- /home/shostako/.claude/chrome/chrome-native-host
```
ファイル名: `com.anthropic.claude_browser_extension.bat`

**2. JSONファイル（Native Messaging Host登録）**
```json
{
  "name": "com.anthropic.claude_browser_extension",
  "description": "Claude Browser Extension Native Host (WSL Bridge)",
  "path": "C:\\Users\\shost\\AppData\\Roaming\\Claude\\ChromeNativeHost\\com.anthropic.claude_browser_extension.bat",
  "type": "stdio",
  "allowed_origins": [
    "chrome-extension://dihbgbndebgnbjfmelmegjepbnkhlgni/",
    "chrome-extension://fcoeoabgfenejglbffodgkkbkcdhcgfn/",
    "chrome-extension://dngcpimnedloihjnnfngkgjoidhnaolf/"
  ]
}
```
ファイル名: `com.anthropic.claude_browser_extension.json`

**3. シンボリックリンク（WSL側）**
```bash
ln -s "/mnt/c/Users/shost/AppData/Local/Google/Chrome/User Data/Default/Extensions/fcoeoabgfenejglbffodgkkbkcdhcgfn" \
      ~/.config/google-chrome/Default/Extensions/fcoeoabgfenejglbffodgkkbkcdhcgfn
```

### 使用方法

**現状**: PowerShellでbatを手動起動する必要がある
```powershell
& "C:\Users\shost\AppData\Roaming\Claude\ChromeNativeHost\com.anthropic.claude_browser_extension.bat"
```

その後、WSL側のClaude Codeから`mcp__claude-in-chrome__*`ツールが使える。

### 結果

**完全動作確認！** Chromeからの自動起動も正常に動作。PowerShell手動起動は不要だった（Chrome再起動後は自動でbatが起動される）

### 参考

- GitHub Issue: https://github.com/anthropics/claude-code/issues/14367
- @illusive-ch のコメントが元ネタ

---
