# 2026年1月 作業ログ

## 2026-01-21 作業概要（夜2）

### P統合シート・マクロ作成（成形P/加工P/塗装P）

**背景**: T/H/Gの出力テーブルを1つのシートに統合して印刷用レイアウトを作成したい

**方針**: 従来マクロを流用し、出力テーブルをコピーして新シートに貼り付ける方式を採用

**1. 成形P統合マクロ作成**:
- m転記_統合_成形P.bas新規作成
- `_集計期間成形P`から期間名を取得
- 各期間でG→T→Hテーブルをコピー（タイトル行含む、間隔2行）
- 期間ごとに改ページ挿入
- 印刷設定: FitToPagesWide=1, FitToPagesTall=False

**2. 加工P/塗装P統合マクロ作成**:
- 成形Pをベースにテーブル名を置換
- 同じ構造・同じ処理フロー

**3. 各一括マクロにP追加**:
- m転記_一括_成形/加工/塗装.bas
- targetSheets/targetTables/macroNamesにP追加
- 実行順序の最後にP（T/H/Gの後）

**4. 印刷レイアウト修正**:
- 加工Pで中央配置になっていた問題を修正
- CenterVertically = False, CenterHorizontally = False追加
- 3つのPマクロすべてに適用

**Pシートに必要なテーブル**:
- `_流出項目{工程}P`
- `_集計期間{工程}P`

---

## 2026-01-21 作業概要（夜）

### 加工系マクロの整備（NWシート統合）

**背景**: 前回セッションで作成した加工NWマクロを、関連マクロに統合

**1. m転記_見せる表_加工.bas改造**:
- 期間検証追加（加工G vs 加工NW）
- 加工NWテーブル参照追加（`_日報W_加工_期間1`）
- 7行目ショット数の転記元を流出G→加工NWに変更
- **理由**: 加工は最終工程のためNWの不良数は基本ゼロ、ショット数のみNWから取得

**2. m転記_一括_加工.bas改造**:
- 対象シート配列に「加工NW」追加
- 対象テーブル配列に「_集計期間日報加工W」追加
- 実行マクロ配列に「転記_日報_加工NW」追加

**3. mクエリ参照元変更_複数月対応.bas改造**:
- カウンター変数追加（updateCountKako）
- 対象シート配列に「加工NW」追加
- クエリ判定分岐に「日報加工」追加
- 補助関数`Create日報加工複数月結合Query`追加
  - ファイルパス: `Z:\全社共有\オート事業部\日報\加工日報\{年}年\加工日報まとめ-{yyyy-mm}.xlsm`
  - テーブル: 加工日報
  - 出力列: 日付, 品番, ロット, ショット数, 不良数, 成形不良, プライマー付着, テープ貼り失敗, テープ蛇行, テープ内異物, キズ付け, その他

---

## 2026-01-21 作業概要（夕方）

### 加工NW（日報ワースト順）マクロ新規作成

**背景**: 成形NW、塗装NWに続き、加工用の日報ワースト順マクロを作成

**1. 既存NWマクロの比較分析**:
- 成形NW vs 成形NW1: 固定項目機能（打出し、チョコ停打出し）の有無
- 塗装NW: 固定項目なし、「その他O」特殊処理あり

**2. m転記_日報_加工NW.bas新規作成**:
- 塗装NWをベースに作成
- 不良項目7種: 成形不良, プライマー付着, テープ貼り失敗, テープ蛇行, テープ内異物, キズ付け, その他
- ソート: QuickSortDesc
- テーブルスタイル: TableStyleLight16

**3. 集計ロジック（加工特有・複雑）**:

| 判定 | 条件 | 振り分け先 | 倍率 |
|------|------|-----------|------|
| パターンA | 品番=62-58040Fr等 | FrLH/RH両方 | ×1 |
| パターンB | ロット=「単」かつ品番に特定数字含む | 特定1グループ | ×2 |
| 補給品① | 上記以外かつロット=「単」 | 補給品 | ×2 |
| 補給品② | 上記以外かつロット≠「単」 | 補給品 | 末尾LH/RH→×1、それ以外→×2 |

**パターンA（62-xxxxx形式）**:
- 62-58040Fr, 62-58050Fr, 62-58060Fr → 58050FrLH/RH両方
- 62-58040Rr, 62-58050Rr, 62-58060Rr → 58050RrLH/RH両方
- 62-28030Fr〜62-28060Fr → 28050FrLH/RH両方
- 62-28030Rr〜62-28060Rr → 28050RrLH/RH両方

**パターンB（ロット=「単」かつ特定数字含む）**:
- 58050FrLH: 58042, 58052, 58062
- 58050FrRH: 58041, 58051, 58061
- 58050RrLH: 58056, 58066
- 58050RrRH: 58055, 58065
- 28050FrLH: 28032, 28042, 28052, 28062
- 28050FrRH: 28031, 28041, 28051, 28061
- 28050RrLH: 28036, 28046, 28056, 28066
- 28050RrRH: 28035, 28045, 28055, 28065

**テーブル構成**:
- 期間テーブル: シート「加工NW」、テーブル「_集計期間日報加工W」
- ソーステーブル: シート「日報加工」、テーブル「_日報加工」
- 項目テーブル: シート「加工NW」、テーブル「_日報項目加工W」
- 出力テーブル: シート「加工NW」、複数テーブル「_日報W_加工_{期間名}」

**出力形式**:
- 1行目: ショット数
- 2行目: 不良数
- 3行目以降: ワースト順項目

---

## 2026-01-21 作業概要（午後2）

### 廃棄マクロ・流出マクロのショット数処理削除

**背景**: ロット数量テーブルの廃止に向けた準備（続き）

**1. m転記_廃棄_成形H/塗装H/加工H.bas修正**:
- ショット数関連処理を全削除
  - `wsLot`, `tblLot`, `lotData`, `lotArr` 変数
  - `colLotHizuke`, `colLotKoutei`, `colLotHinban2`, `colLotSuuryou` 列インデックス
  - `aggShot` Dictionary
  - ロット数量テーブルの参照取得・必須チェック
  - ショット数集計ループ
  - 出力の「ショット数」行
- 出力テーブルの1行目を「不良数」に変更

**集計条件（変更なし）**:
- 成形H: 工程=成形
- 塗装H: 工程=塗装
- 加工H: 工程=加工

**2. m転記_流出_成形G/塗装G/加工G.bas修正**:
- ショット数関連処理を全削除（廃棄マクロと同様）
- 出力テーブルの1行目を「不良数」に変更
- 成形GのソートをBubbleSortDesc → QuickSortDescに統一

**集計条件（変更なし）**:
- 成形G: 手直し(発生=成形 AND 発見2≠成形) + 廃棄(工程=成形)
- 塗装G: 手直し(発生=塗装 AND 発見2≠塗装) + 廃棄(工程=塗装)
- 加工G: 手直し(発生=加工 OR 発生=モール) + 廃棄(工程=加工)

**効果**:
- 合計9マクロがロット数量テーブルを参照しなくなった
  - 手直し系: 成形T, 塗装T, 加工T
  - 廃棄系: 成形H, 塗装H, 加工H
  - 流出系: 成形G, 塗装G, 加工G

---

## 2026-01-21 作業概要（午後）

### 手直しクエリ関連の大幅改修

**背景**: ロット数量テーブルの廃止に向けた準備

**1. 手直しクエリ修正（手直しクエリ.pq）**:
- 前月・当月の2ファイル結合 → 年単位ファイル単独参照に変更
- 参照先: `不良調査表DB-yyyy.accdb`
- 「品番末尾」「注番月」列を選択リストから除外

**2. mクエリ参照元変更_複数月対応.bas修正**:
- ロット数量クエリ作成（`Createロット数量Query`）を削除
- 番号固定クエリ作成（`Create番号固定Query`）を削除
- 不良集計ゾーン別 → 手直しクエリに関数名変更（`Create手直しQuery`）
- 年単位ファイル参照に変更（G2のyyyyを抽出）
- 手直しシートを対象シートから除外（G1/G2同期不要）

**3. m転記_手直し_成形T/塗装T/加工T.bas新規作成**:
- ショット数関連処理を全削除
  - `wsLot`, `tblLot`, `lotData`, `lotArr` 変数
  - `aggShot` Dictionary
  - ロット数量テーブルからのショット数集計ループ
  - 出力の「ショット数」行
- 出力テーブルの1行目を「不良数」に変更
- これら3マクロはロット数量テーブルを一切参照しなくなった

**集計条件（変更なし）**:
- 成形T: `発生=成形 AND 発見2≠成形`
- 塗装T: `発生=塗装 AND 発見2≠塗装`
- 加工T: `発生=加工 OR 発生=モール`

**効果**:
- ロット数量テーブル廃止への準備完了
- 手直し系マクロの簡素化

---

## 2026-01-21 作業概要（午前）

### UserForm5 完成（微調整・機能追加）

**入力制限の追加**:
- CTextBoxEventクラスハンドラを動的生成TextBoxに接続
- 配列で管理（dateHandlers, lotHandlers, zoneHandlers, numberHandlers, quantityHandlers, returnHandlers）
- Initialize時にReDim、CreateRecordRow時に接続、ClearDynamicControls時に解放

**フォント設定**:
- 動的コントロール: Meiryo UI, サイズ9
- コマンドボタン・トグル: Yu Gothic UI, サイズ12, 太字

**ID欄の窪み対応**:
- LabelからTextBoxに変更
- `SpecialEffect = fmSpecialEffectSunken`
- `Locked = True`, `TabStop = False`
- `BackColor = &H8000000F`（システムボタンフェイス色）

**選択列の削除**:
- ユーザー判断：「修正は何も変更しなければ同値上書き、削除は最初からIDを絞れば済む」
- COL_CHK定数、CheckBox生成・削除処理、選択カウント処理を全削除
- 各行のコントロール数: 9 → 8

**TabIndex設定**:
- 西暦(0)→トグル(1)→ID指定(2)→検索(3)→動的行（各行8コントロール）→実行→閉じる
- 検索後は1行目の日付にフォーカス

**誤操作防止**:
- 検索後：トグル・ID欄・検索ボタンを無効化（Enabled = False）
- 実行後・エラー後：再有効化

**レイアウト微調整**:
- BUTTON_MARGIN: 40 → 15（ボタン余白縮小）
- DATA_START_TOP: 124 → 114（ヘッダー・データ行間の余白縮小）
- LABEL_INDENT: 4追加（ヘッダーラベルを半角分右へ）

**最終的な列位置定数**:
```vba
Private Const COL_ID As Integer = 12
Private Const COL_DATE As Integer = 60
Private Const COL_ITEM As Integer = 134
Private Const COL_LOT As Integer = 213
Private Const COL_FIND As Integer = 253
Private Const COL_ZONE As Integer = 293
Private Const COL_NUM As Integer = 333
Private Const COL_QTY As Integer = 373
Private Const COL_RET As Integer = 413
```

**教訓**:
- 動的生成TextBoxにもCTextBoxEventクラスハンドラを接続できる（配列で管理）
- 選択列は不要な場合が多い（処理対象をIDで絞る方がシンプル）

### UserForm5 追加機能

**ID範囲指定対応**:
- `22-25` → 22,23,24,25 に展開
- カンマ区切りと範囲指定の混在可能（例: `22-25,30,32-34`）
- ParseIDInput関数を追加

**DataModifiedフラグ追加**:
- `Public DataModified As Boolean`
- 修正または削除が実行されたらTrue
- 呼び出し元でクエリ更新の判定に使用

**削除モード対応**:
- 検索後：データコントロールを無効化（Enabled = False）
- 検索後：実行ボタンにフォーカス
- 削除実行後：フォームを自動で閉じる（Unload Me）

### 転送マクロ改修

**mゾーン別データ転送ADO.bas**:
- targetFieldsから「品番末尾」「注番月」を削除
- 理由：入力フォームからこれらのフィールドを削除済み

### クエリ西暦更新マクロ新規作成

**mクエリ西暦更新.bas**:
- シート「不良集計ゾーン別ADO」G2から年を取得
- Power Queryの接続先DBを動的変更
- クエリをリフレッシュ

**不良集計ゾーン別ADO.pq**:
- 年間DB（不良調査表DB-{年}.accdb）のみ参照
- 月別DB結合処理を削除

### 自動採番リセットマクロ改修

**m自動採番リセットAccess.bas**:
- DBパスを動的構築に変更（他マクロと統一）
- InputBoxで年を入力
- Dir()でファイル存在チェック追加

---

## 2026-01-20 作業概要

### 品番末尾・注番月フィールド削除

**背景**: 不良集計入力フォームの簡素化

**変更ファイル**:
- `src/UserForm2.frm` - ComboBox3（品番末尾）、TextBox2（注番月）を削除
- `src/CTextBoxEvent.cls` - Monthタグ処理を削除
- `src/mゾーン別データ転送ADO.bas` - targetFieldsから品番末尾・注番月を削除

**注意点**: Access側の列は残っても問題なし（INSERTで指定しないフィールドはNULLになるだけ）

---

### UserForm5（データ修正・削除フォーム）新規作成

**背景**:
- 入力者を別の人に譲渡予定
- Access本体を直接触らせたくない（操作ミス・破損リスク）
- パワークエリで読み込んだ際にID列が見えるため、IDベースでの特定が可能

**設計**:
- 同一フォームで修正・削除（トグルボタンで切替）
- 年は現在西暦をデフォルト、変更可能
- ID入力はカンマ区切り（最大10件）
- 検索後に動的コントロール生成（ヘッダーラベルも動的）
- トランザクション制御（エラー時ロールバック）

**静的コントロール**:
- ComboBoxYear（西暦選択）
- ToggleButtonMode（修正/削除切替）
- TextBoxIDs（ID入力）
- CommandButtonSearch, CommandButtonExecute, CommandButtonClose

**動的コントロール**:
- ヘッダーラベル10個（ID, 日付, 品番, ロット, 発見, ゾーン, 番号, 数量, 差戻, 選択）
- データ行（最大10行 × 10コントロール）

**列位置定数**:
```vba
Private Const COL_ID As Integer = 12
Private Const COL_DATE As Integer = 60
Private Const COL_ITEM As Integer = 134
Private Const COL_LOT As Integer = 213
Private Const COL_FIND As Integer = 253
Private Const COL_ZONE As Integer = 293
Private Const COL_NUM As Integer = 333
Private Const COL_QTY As Integer = 373
Private Const COL_RET As Integer = 413
Private Const COL_CHK As Integer = 450
```

**教訓**:
- ヘッダーラベルを静的配置すると動的生成コントロールと位置がズレる
- 解決策: ヘッダーラベルも動的生成にして列位置定数を共有

---

## 2026-01-12 作業概要

### Windows環境のexcel-autoプロジェクト問題分析

**発端**:
- Windows環境（WezTerm + PowerShell）でexcel-autoプロジェクトを運用
- ファイル読み込み/書き込みでエラーが頻発
- 日本語ファイル名の文字化け

**根本原因特定**:
- Claude CodeのBashツールはGit Bash（`/usr/bin/bash`）を使用
- ナレッジにはPowerShellコマンド（`Get-Content -Encoding oem`）を記載
- bash → pwsh の二重シェル層で日本語パスが文字化け

**調査結果**:
- Claude Codeに`defaultShell`設定は存在しない
- Unix系シェル（bash）前提の設計思想
- PowerShellネイティブ対応は公式には未サポート
- GitHub Issue #6453で同様の問題が報告済み

**結論**:
- excel-autoプロジェクトはWSL環境に戻す
- WSL2（本物のLinux）の方がClaude Codeとの相性が良い

### Windows版ナレッジのWSL版へのマージ

**マージ対象**（環境非依存の知見）:

1. **11-vba-coding-standards.md** に追加:
   - コメント標準セクション（ヘッダーコメント必須/任意項目）
   - 実例（転記マクロ）
   - 「なぜActivateが禁止なのか（過去の失敗から）」詳細セクション
   - 症状診断フロー
   - 最適化の優先順位（黄金律）

2. **12-vba-encoding.md** に追加:
   - 参照名の確認（推測禁止）セクション

**環境依存部分**:
- パス、変換コマンドはWSL用（iconv、bash）のまま維持
- PowerShellコマンドの混入なし

### /vbaコマンド新規作成

**目的**: VBAマクロ生成ワークフローの標準化

**設置場所**: `~/.claude/commands/vba.md`

**内容**:
1. 処理概要確認
2. 情報十分性判断（A: 生成開始 / B: 追加情報）
3. 追加情報収集（Bの場合）
4. 参考マクロ読み込み（iconv変換）
5. excel-vba-expertスキル呼び出し
6. マクロ生成 + bas2sjis変換

**Windows版との差分**: 環境依存コマンドのみ（iconv、bas2sjis bash版）

### WezTermでWSL環境を使う設定

**背景**:
- WSLのUbuntuターミナルではShift+Enterが非対応
- WezTermはShift+Enterをネイティブサポート
- 以前は「wsl → Enter → cd ~」の手間を嫌ってWindows専用にしていた

**解決策**: Logicool Options+でショートカット設定
- ショートカット1: WezTerm → Windows環境（lab用）
- ショートカット2: WezTerm → WSL環境（excel-auto用）

**メリット**:
- 両環境でShift+Enter対応
- ワンクリックで環境切り替え
- WezTermのdefault設定を弄る必要なし

**補足**: WezTermからWSLに入るとカレントディレクトリが`/mnt/c/Users/shost`になる。WSLホームに移動するには`cd ~`。自動化したい場合はWezTerm設定で`--cd ~`オプションを追加。

---

## 2026-01-12 Claude in Chrome WSLブリッジ設定

### 問題

WSL環境からClaude CodeのChrome MCP（`mcp__claude-in-chrome__*`）を使おうとすると「Browser extension is not connected」エラー。

### 原因

1. Chrome拡張機能はWindows側のNative Messaging Hostを使う
2. WSLとWindowsは別環境なので直接通信できない
3. 拡張機能が使うNative Host名が`com.anthropic.claude_browser_extension`（ブリッジは別名で登録していた）

### 解決策：WSL-Windows ブリッジ

**設定ファイル場所**: `C:\Users\shost\AppData\Roaming\Claude\ChromeNativeHost\`

**1. batファイル（ブリッジ本体）**
```batch
@echo off
wsl.exe -d Ubuntu-22.04 -- /home/shostako/.claude/chrome/chrome-native-host
```
ファイル名: `com.anthropic.claude_browser_extension.bat`

**2. JSONファイル（Native Messaging Host登録）**
```json
{
  "name": "com.anthropic.claude_browser_extension",
  "description": "Claude Browser Extension Native Host (WSL Bridge)",
  "path": "C:\\Users\\shost\\AppData\\Roaming\\Claude\\ChromeNativeHost\\com.anthropic.claude_browser_extension.bat",
  "type": "stdio",
  "allowed_origins": [
    "chrome-extension://dihbgbndebgnbjfmelmegjepbnkhlgni/",
    "chrome-extension://fcoeoabgfenejglbffodgkkbkcdhcgfn/",
    "chrome-extension://dngcpimnedloihjnnfngkgjoidhnaolf/"
  ]
}
```
ファイル名: `com.anthropic.claude_browser_extension.json`

**3. シンボリックリンク（WSL側）**
```bash
ln -s "/mnt/c/Users/shost/AppData/Local/Google/Chrome/User Data/Default/Extensions/fcoeoabgfenejglbffodgkkbkcdhcgfn" \
      ~/.config/google-chrome/Default/Extensions/fcoeoabgfenejglbffodgkkbkcdhcgfn
```

### 使用方法

**現状**: PowerShellでbatを手動起動する必要がある
```powershell
& "C:\Users\shost\AppData\Roaming\Claude\ChromeNativeHost\com.anthropic.claude_browser_extension.bat"
```

その後、WSL側のClaude Codeから`mcp__claude-in-chrome__*`ツールが使える。

### 結果

**完全動作確認！** Chromeからの自動起動も正常に動作。PowerShell手動起動は不要だった（Chrome再起動後は自動でbatが起動される）

### 参考

- GitHub Issue: https://github.com/anthropics/claude-code/issues/14367
- @illusive-ch のコメントが元ネタ

---
